<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarX AI</title>
    <!-- Thêm các thư viện cần thiết -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" id="hljs-light-theme" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">
    <link rel="stylesheet" id="hljs-dark-theme" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" disabled>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style> /* Gemini Code Assist: Modern UI Refresh v2 */
        :root {
            --primary-color: #4285F4;
            --primary-light: #e8f0fe;
            --primary-dark: #3367D6;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --bg-main: #f9fbfd;
            --bg-secondary: #ffffff;
            --border-color: #e0e0e0; /* Used for distinct borders */
            --border-light: #f1f3f4; /* Used for subtle borders/dividers */
            --bg-hover: #f1f3f4;
            --bg-disabled: #f1f3f4;
            --text-disabled: #a1a1a1;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --sidebar-width: 280px;
            --chat-container-width: 850px;
            --input-height: 56px;
            --border-radius-sm: 6px;
            --border-radius-md: 12px;
            --border-radius-lg: 24px;
            --transition-fast: all 0.2s ease-in-out;
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode {
            --primary-color: #6ea6ff;
            --primary-light: rgba(110, 166, 255, 0.1);
            --primary-dark: #8ab4f8;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --bg-main: #1e1f22;
            --bg-secondary: #2b2d31;
            --border-color: #5f6368;
            --border-light: #3c4043;
            --bg-hover: #3c4043;
            --bg-disabled: #3c4043;
            --text-disabled: #70757a;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
        }
        
        /* Table Styles */
        .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 15px;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-md);
            overflow: hidden; /* Ensures border-radius is respected by children */
            box-shadow: var(--shadow-sm);
        }
        .message-content th, .message-content td {
            border-bottom: 1px solid var(--border-light);
            padding: 12px 15px;
            text-align: left;
        }
        .message-content th {
            background-color: var(--bg-hover);
            font-weight: 600;
        }
        .message-content tbody tr:last-child td {
            border-bottom: none;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            display: flex;
            height: 100vh;
            background-color: var(--bg-main);
            color: var(--text-primary);
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-main);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: transform 0.3s ease, background-color 0.3s;
            z-index: 100;
            padding: 8px;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                transform: translateX(-100%);
                width: 85%;
                max-width: 320px;
                height: 100%;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
                padding: 0;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 99;
                backdrop-filter: blur(2px);
                display: none;
            }
            
            .sidebar-overlay.active {
                display: block;
            }
        }
        
        .sidebar-header {
            padding: 8px;
            border-bottom: 1px solid var(--border-light);
        }

        @media (max-width: 768px) {
            .sidebar-header {
                padding: 16px;
            }
        }
        
        .new-chat-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: var(--border-radius-md);
            background-color: var(--primary-light);
            color: var(--primary-dark);
            cursor: pointer;
            transition: var(--transition-fast);
            font-weight: 600;
            font-size: 15px;
        }
        
        .new-chat-btn:hover {
            background-color: var(--primary-dark);
            color: white;
            transform: scale(1.03);
            box-shadow: var(--shadow-md);
        }

        body.dark-mode .new-chat-btn {
            color: var(--primary-color);
        }

        body.dark-mode .new-chat-btn:hover {
            color: var(--bg-secondary);
        }

        .new-chat-btn svg {
            width: 20px;
            height: 20px;
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
            scrollbar-width: thin; /* For Firefox */
            scrollbar-color: var(--border-color) transparent;
        }
        
        .history-group-header {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 16px 16px 8px 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 8px;
        }
        
        .chat-history::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-history::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 3px;
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-radius: var(--border-radius-md);
            margin: 4px 8px;
            font-size: 14px;
            transition: var(--transition-fast);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .chat-item-title {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 8px;
        }

        .chat-item-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s ease-in-out;
            flex-shrink: 0;
        }

        .chat-item:hover .chat-item-actions,
        .chat-item.editing .chat-item-actions {
            opacity: 1;
        }

        .chat-item-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .chat-item-btn:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .chat-item-input {
            width: 100%;
            background-color: var(--bg-hover);
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius-sm);
            padding: 2px 6px;
            font-size: 14px;
            color: var(--text-primary);
            outline: none;
            font-weight: 500;
        }
        
        .chat-item:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .chat-item.active {
            background-color: var(--primary-light);
            font-weight: 600;
            color: var(--primary-dark);
        }
        body.dark-mode .chat-item.active {
            color: #8ab4f8;
        }
        
        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        @media (max-width: 768px) {
            .sidebar-footer {
                padding: 16px;
            }
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: background-color 0.2s;
            flex: 1;
            min-width: 0; /* Ensures the element can shrink and text can be truncated */
        }
        
        .user-profile:hover {
            background-color: var(--bg-hover);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-light);
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 600;
        }
        
        body.dark-mode .user-avatar {
            color: var(--primary-color);
        }

        .user-name {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }
        
        /* Main content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            position: relative;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-lg) 0 0 var(--border-radius-lg);
            box-shadow: -5px 0 15px rgba(0,0,0,0.03);
        }

        @media (max-width: 768px) {
            .main-content {
                border-radius: 0;
                box-shadow: none;
            }
        }
        
        /* Mobile header */
        .mobile-header {
            display: none;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
            background-color: var(--bg-secondary);
            align-items: center;            
            gap: 16px;
            z-index: 10;
        }
        
        @media (max-width: 768px) {
            .mobile-header {
                display: flex;
            }
        }
        
        .menu-btn {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            border-radius: 50%;
            transition: var(--transition-fast);
        }

        .menu-btn:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .mobile-title {
            font-weight: 600;
            font-size: 18px;
            color: var(--text-primary);
        }
        
        /* Chat container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: var(--chat-container-width);
            width: 100%;
            margin: 0 auto;
            padding: 24px 16px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        @media (max-width: 768px) {
            .chat-container {
                padding: 16px 12px;
            }
        }
        
        @keyframes message-fade-in {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            margin-bottom: 24px;
            display: flex;
            flex-direction: column;
            animation: message-fade-in 0.4s cubic-bezier(0.215, 0.610, 0.355, 1.000) both;
        }
        
        .message-user {
            display: flex;
            padding: 0;
            gap: 16px;
            max-width: 100%;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: 1px solid var(--border-light);
        }

        .message-avatar.user-avatar-bg {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }

        body.dark-mode .message-avatar.user-avatar-bg {
            color: var(--primary-color);
        }
        
        .message-content {
            flex: 1;
            padding-top: 6px;
            line-height: 1.7;
            font-size: 16px;
            color: var(--text-primary);
            word-wrap: break-word;
        }
        
        .message-content pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 10px 0;
            padding: 0;
            background: none;
            border: none;
        }
        
        .message-content code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
            background-color: var(--bg-hover);
            padding: 2px 5px;
            border-radius: var(--border-radius-sm);
        }
        
        .code-block {
            position: relative;
            margin: 16px 0;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            border: 1px solid var(--border-light);
            background-color: var(--bg-main);
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--bg-hover);
            border-bottom: 1px solid var(--border-light);
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .code-language {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }
        
        .code-actions {
            display: flex;
            gap: 4px;
        }
        
        .code-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: var(--border-radius-sm);
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .code-btn:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .code-btn.active {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }

        body.dark-mode .code-btn.active {
            color: var(--primary-color);
        }
        
        .code-content {
            /* Padding and overflow are handled by highlight.js on the <pre><code> element */
        }

        .code-content pre {
            margin: 0;
        }

        .code-content pre code {
            padding: 12px;
            background: none;
            display: block;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .code-preview-wrapper {
            border-top: 1px solid var(--border-light);
        }

        .code-preview-header {
            padding: 12px;
            background-color: var(--bg-hover);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-light);
        }

        .code-preview-iframe {
            width: 100%;
            height: 400px;
            border: none;
            background-color: var(--bg-secondary);
        }

        /* Dark mode overrides for code block */
        body.dark-mode .code-block {
            border: 1px solid var(--border-light);
            background-color: var(--bg-secondary);
        }
        body.dark-mode .code-header {
            background-color: var(--bg-main);
        }
        body.dark-mode .code-btn:hover {
            background-color: var(--border-color);
            border-color: var(--border-color);
        }
        
        .file-preview {
            margin-top: 10px;
            border-radius: var(--border-radius-md);
            max-width: 100%;
            max-height: 200px;
            border: 1px solid var(--border-light);
        }
        
        @media (max-width: 768px) {
            .message-content {
                font-size: 15px;
            }
        }
        
        .message-ai .message-avatar {
            background: linear-gradient(135deg, var(--primary-color), #67a2ff);
            color: white;
            border: none;
        }

        body.dark-mode .message-ai .message-avatar {
            background: var(--primary-color);
            color: var(--bg-secondary);
        }
        
        /* Input area */
        .input-area {
            padding: 16px 24px;
            background-color: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        @media (max-width: 768px) {
            .input-area {
                padding: 12px;
            }
        }
        
        .input-container {
            max-width: var(--chat-container-width);
            width: 100%;
            position: relative;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-md);
            transition: var(--transition-smooth);
        }

        .input-container:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light), var(--shadow-md);
        }
        
        .input-box {
            width: 100%;
            padding: 16px 100px 16px 24px;
            border: none;
            border-radius: var(--border-radius-lg);
            resize: none;
            min-height: var(--input-height);
            max-height: 300px; /* Increased max height */
            outline: none;
            font-size: 16px;
            line-height: 1.5;
            background-color: transparent;
            transition: height 0.2s ease-in-out;
            color: var(--text-primary);
        }
        
        .input-box:focus {
            /* Focus is handled by .input-container:focus-within */
        }
        
        .input-actions {
            position: absolute;
            right: 10px;
            bottom: 10px;
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .upload-btn, .send-btn {
            background-color: var(--bg-hover);
            color: var(--text-secondary);
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .upload-btn:hover {
            background-color: var(--border-color);
            transform: scale(1.05);
        }
        
        .upload-btn input {
            display: none;
        }
        
        .send-btn {
            background: linear-gradient(135deg, var(--primary-color), #67a2ff);
            color: white;
        }

        body.dark-mode .send-btn {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            color: var(--bg-secondary);
        }
        
        .send-btn:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }
        
        .send-btn:disabled {
            background: var(--bg-disabled);
            color: var(--text-disabled);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .disclaimer-text {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 12px;
            padding: 0 16px;
            max-width: var(--chat-container-width);
            width: 100%;
        }
        
        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
        }
        
        .empty-state h1 {
            font-size: 52px;
            font-weight: 700;
            margin-bottom: 16px;
            background: linear-gradient(90deg, #4285F4, #9333ea, #E94235);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% auto;
            animation: text-gradient-animation 5s ease-in-out infinite;
        }

        @keyframes text-gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @media (max-width: 768px) {
            .empty-state h1 {
                font-size: 36px;
            }
        }
        
        .empty-state p {
            color: var(--text-secondary);
            max-width: 600px;
            margin-bottom: 32px;
            font-size: 16px;
            line-height: 1.6;
        }
        
        @media (max-width: 768px) {
            .empty-state p {
                font-size: 14px;
                margin-bottom: 24px;
            }
        }
        
        .capabilities {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 32px;
            width: 100%;
            max-width: 650px;
        }
        
        @media (max-width: 768px) {
            .capabilities {
                grid-template-columns: 1fr;
                margin-top: 24px;
                gap: 12px;
            }
        }
        
        .capability-card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-md);
            padding: 20px;
            text-align: left;
            box-shadow: none;
            transition: var(--transition-smooth);
            border: 1px solid var(--border-light);
            cursor: pointer;
        }
        
        .capability-card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        body.dark-mode .capability-card {
            background-color: var(--bg-main);
        }
        
        @media (max-width: 768px) {
            .capability-card {
                padding: 16px;
            }
        }
        
        .capability-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        @media (max-width: 768px) {
            .capability-card h3 {
                font-size: 14px;
            }
        }
        
        .capability-card h3 svg {
            color: var(--primary-color);
            flex-shrink: 0;
        }

        .capability-card p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin: 0;
        }
        
        @media (max-width: 768px) {
            .capability-card p {
                font-size: 13px;
            }
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: none;
            padding: 20px 0;
            align-items: center;
            gap: 16px;
        }
        
        .typing-dots {
            display: flex;
            gap: 5px;
            padding-left: 6px;
        }
        
        .typing-dot {
            width: 9px;
            height: 9px;
            background-color: var(--border-color);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0);
                background-color: var(--border-color);
            }
            30% {
                transform: translateY(-6px);
                background-color: var(--text-secondary);
            }
        }
        
        /* Scroll to bottom button */
        .scroll-to-bottom {
            position: absolute;
            right: 24px;
            bottom: 100px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-fast);
            z-index: 10;
            color: var(--text-secondary);
        }
        
        .scroll-to-bottom:hover {
            background-color: var(--bg-hover);
            transform: scale(1.1);
            color: var(--text-primary);
        }
        
        .scroll-to-bottom.visible {
            opacity: 1;
            visibility: visible;
            bottom: 120px;
        }
        
        @media (max-width: 768px) {
            .scroll-to-bottom {
                right: 16px;
                bottom: 80px;
                width: 36px;
                height: 36px;
            }
            .scroll-to-bottom.visible {
                bottom: 90px;
            }
        }

        /* Loading spinner */
        .spinner {
            display: none;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        /* Cleaner loading state for send button */
        .send-btn #sendIcon {
            display: block;
        }
        .send-btn.loading #sendIcon {
            display: none;
        }
        .send-btn .spinner {
            display: none;
        }
        .send-btn.loading .spinner {
            display: block;
        }

        body.dark-mode .spinner {
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-top-color: var(--bg-secondary);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Typing animation for message content */
        .typing-content {
            display: inline-block;
            overflow: hidden;
            border-right: 2px solid var(--primary-color);
            white-space: nowrap;
            animation: blinkCursor 0.75s step-end infinite;
        }

        @keyframes blinkCursor {
            from, to { border-color: transparent; }
            50% { border-color: var(--primary-color); }
        }

        /* Markdown styles */
        .message-content strong, .message-content b {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .message-content em, .message-content i {
            font-style: italic;
        }
        
        .message-content u {
            text-decoration: underline;
        }

        /* Theme Toggle Button */
        .theme-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: var(--transition-fast);
        }
        .theme-toggle-btn:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
            transform: scale(1.1) rotate(15deg);
        }
        #theme-icon-moon {
            display: none;
        }
        body.dark-mode #theme-icon-sun {
            display: none;
        }
        body.dark-mode #theme-icon-moon {
            display: block;
        }

        body.dark-mode .theme-toggle-btn:hover {
            transform: scale(1.1) rotate(-15deg);
        }
    </style>
    <style>
        /* Deep Think Mode Styles */
        .deep-think-btn.active,
        .internet-search-btn.active,
        .research-btn.active {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }

        body.dark-mode .deep-think-btn.active,
        body.dark-mode .internet-search-btn.active,
        body.dark-mode .research-btn.active {
            color: var(--primary-dark);
            background-color: rgba(138, 180, 248, 0.2);
        }

        /* Deep Think Dropdown */
        .input-action-wrapper {
            position: relative;
        }

        .deep-think-menu {
            display: none;
            position: absolute;
            bottom: calc(100% + 8px); /* Position above the button */
            right: 0;
            width: 280px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 20;
            padding: 8px;
            animation: dropdown-fade-in 0.2s ease-out;
        }

        @keyframes dropdown-fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .deep-think-menu.visible {
            display: block;
        }

        .deep-think-option {
            padding: 12px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .deep-think-option:hover {
            background-color: var(--bg-hover);
        }

        .deep-think-option.active {
            background-color: var(--primary-light);
        }

        body.dark-mode .deep-think-option.active {
            background-color: rgba(138, 180, 248, 0.2);
        }

        .deep-think-option strong {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }

        .deep-think-option p {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 4px 0 0 0;
            line-height: 1.4;
        }

        .deep-think-panel .message-content {
            border: 1px solid var(--primary-light);
            background-color: color-mix(in srgb, var(--bg-secondary) 95%, var(--primary-light) 5%);
            border-radius: var(--border-radius-md);
            padding: 16px;
        }

        /* Unified AI Panel Style */
        .ai-panel-content {
            border: none;
            background-color: var(--bg-main);
            border-radius: var(--border-radius-md);
            padding: 16px;
            box-shadow: var(--shadow-sm);
            border-left: 3px solid var(--primary-color);
        }
        body.dark-mode .ai-panel-content {
            background-color: var(--bg-secondary);
            border-left-color: var(--primary-dark);
        }

        .deep-think-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-light);
        }

        .deep-think-header-main {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0; /* Prevent overflow issues */
        }

        .deep-think-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: var(--transition-fast);
            margin-left: 8px;
            flex-shrink: 0;
        }
        .panel-toggle-btn:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }
        .panel-toggle-btn svg {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .panel-toggle-btn.collapsed svg {
            transform: rotate(-90deg);
        }

        body.dark-mode .deep-think-header h3 {
            color: #8ab4f8;
        }

        .deep-think-timer {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .panel-body {
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding-top 0.4s ease-out, margin-top 0.4s ease-out;
            max-height: 1500px; /* A large enough value for content */
            padding-top: 12px;
        }
        .panel-body.collapsed {
            max-height: 0;
            padding-top: 0;
        }

        .deep-think-section {
            margin-top: 16px;
        }

        .deep-think-section h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .thought-step {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .thought-step svg {
            color: #34A853; /* Google's green for success */
            flex-shrink: 0;
        }

        body.dark-mode .thought-step svg {
            color: #81C995; /* Lighter green for dark mode */
        }

        .search-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border-light);
        }

        .search-panel-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-mode .search-panel-header h3 {
            color: #8ab4f8;
        }

        .search-result-item {
            display: flex;
            gap: 12px;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: var(--border-radius-sm);
            transition: background-color 0.2s;
        }
        .search-result-item:hover {
            background-color: var(--bg-hover);
        }

        .search-result-favicon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            margin-top: 4px;
            border-radius: 4px;
        }

        body.dark-mode .search-result-favicon {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--border-light);
        }

        .search-result-title {
            font-size: 15px;
            font-weight: 500;
            color: var(--primary-dark);
            text-decoration: none;
            margin-bottom: 4px;
            display: block;
        }
        .search-result-title:hover {
            text-decoration: underline;
        }
        body.dark-mode .search-result-title {
            color: var(--primary-dark);
        }
        body.dark-mode .search-result-title:hover {
            color: #b3d4ff;
        }

        .search-result-snippet {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin: 0;
        }

        /* Unified Panel Styles */
        .deep-think-panel .message-content,
        .search-panel .message-content {
            border: none;
            background-color: var(--bg-main);
            border-radius: var(--border-radius-md);
            padding: 16px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--primary-color);
        }

        body.dark-mode .deep-think-panel .message-content,
        body.dark-mode .search-panel .message-content {
            background-color: var(--bg-secondary);
            border-left-color: var(--primary-dark);
        }

        /* Intelligence Slider Styles */
        .intelligence-btn.active {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }
        body.dark-mode .intelligence-btn.active {
            color: var(--primary-dark);
            background-color: rgba(138, 180, 248, 0.2);
        }

        #intelligenceSlider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--border-light);
            outline: none;
            border-radius: 3px;
            transition: opacity .2s;
            cursor: pointer;
        }

        #intelligenceSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid var(--bg-secondary);
            box-shadow: var(--shadow-sm);
        }

        #intelligenceSlider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid var(--bg-secondary);
            box-shadow: var(--shadow-sm);
        }
    </style>
    <style>
        /* Research Panel Styles */
        .research-image-gallery {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .research-image-thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-light);
        }
    </style>
    <style>
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 24px 32px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 500px;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-content h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .modal-content p {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .modal-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: 16px;
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: var(--transition-fast);
            margin-bottom: 24px;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .modal-btn-secondary {
            background-color: var(--bg-hover);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .modal-btn-secondary:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .modal-btn-primary {
            background-color: var(--primary-dark);
            color: white;
        }

        .modal-btn-primary:hover {
            background-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" id="newChatBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Cuộc trò chuyện mới
            </button>
        </div>
        
        <div class="chat-history" id="chatHistory">
            <!-- Chat history items will be loaded here dynamically -->
        </div>
        
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar message-avatar-bg">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                    </svg>
                </div>
                <span class="user-name">Profile</span>
            </div>
            <button class="theme-toggle-btn" id="upgradeBtn" title="Nâng cấp tài khoản">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.103l3-3m0 0l3 3m-3-3v10.197M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
            <button class="theme-toggle-btn" id="themeToggleBtn" title="Chuyển đổi giao diện">
                <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.95-4.243l-1.59-1.59M3 12H.75m.386-6.364L2.636 7.136M12 12a4.5 4.5 0 100-9 4.5 4.5 0 000 9z" />
                </svg>
                <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Main content -->
    <div class="main-content">
        <!-- Mobile header -->
        <div class="mobile-header">
            <button class="menu-btn" id="menuBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
            <div class="mobile-title">StarX AI</div>
            <!-- Spacer div removed for a cleaner left-aligned title layout -->
        </div>
        
        <!-- Chat container -->
        <div class="chat-container" id="chatContainer">
            <!-- Empty state -->
            <div class="empty-state" id="emptyState">
                <h1><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="50" height="50"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"></path></svg>StarX Ai</h1>
                <p>Hỏi tôi bất cứ điều gì, từ kiến thức chung đến các chủ đề chuyên sâu như lập trình, khoa học, lịch sử và hơn thế nữa.</p>
                
                <div class="capabilities">
                    <div class="capability-card">
                        <h3>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z"></path>
                            </svg>
                            Sáng tạo nội dung
                        </h3>
                        <p>Viết bài luận, kịch bản, thơ, mã code và nhiều hơn nữa với sự sáng tạo của AI.</p>
                    </div>
                    
                    <div class="capability-card">
                        <h3>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"></path>
                            </svg>
                            Phân tích tài liệu
                        </h3>
                        <p>Tải lên và phân tích tài liệu PDF, Word, Excel để trích xuất thông tin quan trọng.</p>
                    </div>

                    <div class="capability-card">
                        <h3>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"></path>
                            </svg>
                            Hỗ trợ lập trình
                        </h3>
                        <p>Giải thích code, gỡ lỗi, tối ưu hóa và tạo mã cho nhiều ngôn ngữ lập trình.</p>
                    </div>

                    <div class="capability-card">
                        <h3>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"></path>
                            </svg>
                            Kiến thức chuyên sâu
                        </h3>
                        <p>Truy cập kiến thức cập nhật về khoa học, công nghệ, kinh doanh và nhiều lĩnh vực khác.</p>
                    </div>
                </div>
            </div>
            
            <!-- Chat messages will be added here dynamically -->
            
            <!-- Typing indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <div class="message-avatar message-ai">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
                    </svg>
                </div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <!-- File Status Indicator -->
            <div class="typing-indicator" id="fileStatusIndicator" style="display: none;">
                <div class="message-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13" />
                    </svg>
                </div>
                <div id="fileStatusText" style="color: var(--text-secondary); flex: 1; line-height: 1.4;"></div>
            </div>
        </div>
        
        <!-- Input area -->
        <div class="input-area">
            <div class="input-container">
                <textarea class="input-box" id="messageInput" placeholder="Nhập tin nhắn của bạn..." rows="1"></textarea>
                <div class="input-actions">
                    <label class="upload-btn" title="Tải lên tài liệu">
                        <input type="file" id="fileUpload" accept=".txt,.pdf,.jpg,.png,.jpeg,.ppt,.pptx" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13" />
                        </svg>
                    </label>
                    <div class="input-action-wrapper">
                        <button class="upload-btn deep-think-btn" id="deepThinkBtn" title="Chế độ suy nghĩ sâu (Deep Think)">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"></path>
                            </svg>
                        </button>
                        <div class="deep-think-menu" id="deepThinkMenu">
                            <div class="deep-think-option" data-mode="normal">
                                <strong>Deep-Think</strong>
                                <p>Phản hồi tiêu chuẩn, nâng cao.</p>
                            </div>
                            <div class="deep-think-option" data-mode="deeper">
                                <strong>Deeper-Think</strong>
                                <p>Suy nghĩ lâu hơn để có phản hồi tốt nhất.</p>
                            </div>
                            <div class="deep-think-option" data-mode="deepest">
                                <strong>Deepest-Think</strong>
                                <p>Suy nghĩ cẩn thận đưa phản hồi tốt nhất.</p>
                            </div>
                        </div>
                    </div>
                    <button class="upload-btn research-btn" id="researchBtn" title="Nghiên cứu chuyên sâu">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"></path>
                        </svg>
                    </button>
                    <button class="upload-btn internet-search-btn" id="internetSearchBtn" title="Tìm kiếm trên Internet">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
                        </svg>
                    </button>
                    <div class="input-action-wrapper" id="intelligenceControl" style="display: none;">
                        <button class="upload-btn intelligence-btn" id="intelligenceBtn" title="Điều chỉnh độ thông minh">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                            </svg>
                        </button>
                        <div class="deep-think-menu" id="intelligenceMenu">
                            <div style="padding: 12px; width: 200px;">
                                <label for="intelligenceSlider" style="font-size: 14px; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center;">
                                    <span>Độ thông minh</span>
                                    <span id="intelligenceValue" style="font-weight: 600; color: var(--text-primary);">50</span>
                                </label>
                                <input type="range" id="intelligenceSlider" min="0" max="100" value="50" style="width: 100%; margin-top: 8px;">
                            </div>
                        </div>
                    </div>
                    <button class="send-btn" id="sendBtn" disabled>
                        <div class="spinner" id="sendSpinner"></div>
                        <svg id="sendIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 11L12 4M12 4L19 11M12 4V21" />
                        </svg>
                    </button>
                </div>
            </div>
            <p class="disclaimer-text">AI có thể mắc lỗi. Vui lòng kiểm tra thông tin quan trọng.</p>
        </div>
        
        <!-- Scroll to bottom button -->
        <button class="scroll-to-bottom" id="scrollToBottomBtn" title="Cuộn xuống dưới">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3" />
            </svg>
        </button>
    </div>

    <!-- Research Modal -->
    <div class="modal-overlay" id="researchModalOverlay">
        <div class="modal-content" id="researchModalContent">
            <h3>Nghiên cứu chuyên sâu</h3>
            <p>Nhập chủ đề bạn muốn AI thực hiện một báo cáo chi tiết và toàn diện.</p>
            <form id="researchForm">
                <input type="text" id="researchTopicInput" class="modal-input" placeholder="Ví dụ: 'Lịch sử của trí tuệ nhân tạo'" required>
                <div class="modal-actions">
                    <button type="button" class="modal-btn modal-btn-secondary" id="cancelResearchBtn">Hủy</button>
                    <button type="submit" class="modal-btn modal-btn-primary">Bắt đầu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Passkey Modal -->
    <div class="modal-overlay" id="passkeyModalOverlay">
        <div class="modal-content">
            <h3>Nâng cấp tài khoản</h3>
            <p>Nhập Pass-Key của bạn để mở khóa các tính năng cao cấp và tăng giới hạn sử dụng.</p>
            <form id="passkeyForm">
                <input type="text" id="passkeyInput" class="modal-input" placeholder="Ví dụ: Plus-Alpha-Beta.12345" required>
                <div class="modal-actions">
                    <button type="button" class="modal-btn modal-btn-secondary" id="cancelPasskeyBtn">Hủy</button>
                    <button type="submit" class="modal-btn modal-btn-primary">Xác nhận</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmationModalOverlay">
        <div class="modal-content">
            <h3 id="confirmationModalTitle"></h3>
            <p id="confirmationModalMessage"></p>
            <div class="modal-actions">
                <button type="button" class="modal-btn modal-btn-secondary" id="cancelConfirmationBtn">Hủy</button>
                <button type="button" class="modal-btn" id="confirmActionBtn">Xác nhận</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="modal-overlay" id="alertModalOverlay">
        <div class="modal-content">
            <h3 id="alertModalTitle">Thông báo</h3>
            <p id="alertModalMessage"></p>
            <div class="modal-actions">
                <button type="button" class="modal-btn modal-btn-primary" id="alertModalOkBtn">Đã hiểu</button>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        // --- BẮT BUỘC: Cấu hình API cho Gemini ---
        const API_KEYS = [
            "AIzaSyDcjwxioZ64qQCPzSQMHAn_lSo34cyoqqo", // API Key cho Gemini
            "AIzaSyCPeOj4Hb2uB5PIN-Wk_SMgpB24adfgxKo",
            "AIzaSyDM2op_46VkOfmMA2DpYz5WKh0Y5DshcFo",
            "AIzaSyBJicrL0GMM1f1VFAAHtF1tf8A1cl0ARNg",
        ];
        let currentApiKeyIndex = 0;
        const API_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent";
        
        // --- BẮT BUỘC: Cấu hình cho Google Custom Search API (Cách cũ) ---
        const CUSTOM_SEARCH_API_KEY = "AIzaSyDo2Uqcdjfj3aLi6ZsIAu08vZ476yfn-ws"; // API Key cho Custom Search API
        const CUSTOM_SEARCH_ENGINE_ID = "11bff95e8e1f543a5"; // Search Engine ID (cx)
        
        // User Access Configuration
        const ADMIN_PASS_KEY = "Admin-PassKeyV2.ee";
        const VALID_PLUS_KEY_PREFIX = "Plus-Alpha-Beta.";
        const VALID_PLUS_KEY_NUMBERS = ["12345", "54321", "98765", "11223", "33445"]; // Example valid numbers
        const USAGE_LIMITS = {
            normal: 20, // Daily request limit for normal users
            plus: 100,  // Daily request limit for plus users (first 2 days)
        };

        // Initialize PDF.js
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
        
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatContainer = document.getElementById('chatContainer');
            const emptyState = document.getElementById('emptyState');
            const newChatBtn = document.getElementById('newChatBtn');
            const typingIndicator = document.getElementById('typingIndicator');
            const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
            const menuBtn = document.getElementById('menuBtn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const sendSpinner = document.getElementById('sendSpinner');
            const sendIcon = document.getElementById('sendIcon');
            const fileUpload = document.getElementById('fileUpload');
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const hljsLightTheme = document.getElementById('hljs-light-theme');
            const hljsDarkTheme = document.getElementById('hljs-dark-theme');
            const fileStatusIndicator = document.getElementById('fileStatusIndicator');
            const fileStatusText = document.getElementById('fileStatusText');
            const deepThinkBtn = document.getElementById('deepThinkBtn');
            const deepThinkMenu = document.getElementById('deepThinkMenu');
            const internetSearchBtn = document.getElementById('internetSearchBtn');
            const researchBtn = document.getElementById('researchBtn');
            const researchModalOverlay = document.getElementById('researchModalOverlay');
            const researchForm = document.getElementById('researchForm');
            const cancelResearchBtn = document.getElementById('cancelResearchBtn');
            const researchTopicInput = document.getElementById('researchTopicInput');
            const chatHistoryContainer = document.getElementById('chatHistory');
            const confirmationModalOverlay = document.getElementById('confirmationModalOverlay');
            const confirmationModalTitle = document.getElementById('confirmationModalTitle');
            const confirmationModalMessage = document.getElementById('confirmationModalMessage');
            const cancelConfirmationBtn = document.getElementById('cancelConfirmationBtn');
            const confirmActionBtn = document.getElementById('confirmActionBtn');
            const alertModalOverlay = document.getElementById('alertModalOverlay');
            const alertModalTitle = document.getElementById('alertModalTitle');
            const alertModalMessage = document.getElementById('alertModalMessage');
            const alertModalOkBtn = document.getElementById('alertModalOkBtn');
            const upgradeBtn = document.getElementById('upgradeBtn');
            const passkeyModalOverlay = document.getElementById('passkeyModalOverlay');
            const passkeyForm = document.getElementById('passkeyForm');
            const cancelPasskeyBtn = document.getElementById('cancelPasskeyBtn');
            const passkeyInput = document.getElementById('passkeyInput');
            const intelligenceControl = document.getElementById('intelligenceControl');
            const intelligenceBtn = document.getElementById('intelligenceBtn');
            const intelligenceMenu = document.getElementById('intelligenceMenu');
            const intelligenceSlider = document.getElementById('intelligenceSlider');
            const intelligenceValue = document.getElementById('intelligenceValue');

            // State variables
            let conversations = [];
            let currentConversationId = null;
            let chatHistory = [];
            let uploadedFile = null;
            let deepThinkMode = 'off'; // 'off', 'normal', 'deeper', 'deepest'
            let isInternetSearchMode = false;
            let deepThinkTimerInterval = null;
            let userProfile = {};
            let aiIntelligence = 50;
            
            // Toggle sidebar on mobile
            menuBtn.addEventListener('click', function() {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
            });
            
            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            });

            // --- User Profile & Access Control ---
            function loadUserProfile() {
                const savedProfile = localStorage.getItem('starx_user_profile');
                const defaultProfile = {
                    tier: 'normal', // normal, plus, admin
                    requestsToday: 0,
                    lastRequestDate: getTodaysDateString(),
                    plusKey: null,
                    plusActivationDate: null,
                    plusKeyExpiry: null,
                };
                userProfile = savedProfile ? JSON.parse(savedProfile) : defaultProfile;
                
                // Check for Plus key expiration on load
                if (userProfile.tier === 'plus' && userProfile.plusKeyExpiry && new Date() > new Date(userProfile.plusKeyExpiry)) {
                    showAlertModal('Gói Plus đã hết hạn', 'Gói Plus của bạn đã hết hạn. Tài khoản của bạn đã được chuyển về gói thường.');
                    userProfile.tier = 'normal';
                    userProfile.plusKey = null;
                    userProfile.plusActivationDate = null;
                    userProfile.plusKeyExpiry = null;
                    saveUserProfile();
                }

                updateUIForUserTier();
            }

            function saveUserProfile() {
                localStorage.setItem('starx_user_profile', JSON.stringify(userProfile));
            }

            function getTodaysDateString() {
                return new Date().toISOString().split('T')[0];
            }

            function checkUsageLimits() {
                if (userProfile.tier === 'admin') {
                    return false; // No limits for admin
                }

                const today = getTodaysDateString();
                if (userProfile.lastRequestDate !== today) {
                    userProfile.requestsToday = 0;
                    userProfile.lastRequestDate = today;
                    saveUserProfile();
                }

                let limit = USAGE_LIMITS.normal;
                let limitType = 'thường';

                if (userProfile.tier === 'plus') {
                    // Check if within 2-day high-usage window
                    const twoDaysInMillis = 2 * 24 * 60 * 60 * 1000;
                    const activationDate = new Date(userProfile.plusActivationDate);
                    if (new Date() < new Date(activationDate.getTime() + twoDaysInMillis)) {
                        limit = USAGE_LIMITS.plus;
                        limitType = 'Plus (ưu đãi)';
                    } else {
                        limitType = 'Plus';
                    }
                }

                if (userProfile.requestsToday >= limit) {
                    showAlertModal('Đã đạt giới hạn sử dụng', `Bạn đã đạt giới hạn ${limit} yêu cầu cho gói ${limitType} trong ngày hôm nay. Vui lòng quay lại sau hoặc nâng cấp tài khoản.`);
                    return true; // User is blocked
                }

                return false; // User is not blocked
            }

            function handlePasskey(key) {
                // Admin Key
                if (key === ADMIN_PASS_KEY) {
                    userProfile.tier = 'admin';
                    saveUserProfile();
                    updateUIForUserTier();
                    showAlertModal('Chào mừng Admin!', 'Bạn đã đăng nhập với quyền quản trị viên. Tất cả các giới hạn đã được gỡ bỏ.');
                    return;
                }

                // Plus Key
                if (key.startsWith(VALID_PLUS_KEY_PREFIX)) {
                    const keyNumber = key.substring(VALID_PLUS_KEY_PREFIX.length);
                    if (VALID_PLUS_KEY_NUMBERS.includes(keyNumber)) {
                        const usedKeys = JSON.parse(localStorage.getItem('starx_used_plus_keys') || '{}');
                        if (usedKeys[key] && new Date() > new Date(usedKeys[key])) {
                            showAlertModal('Lỗi', 'Pass-Key này đã được sử dụng và đã hết hạn.');
                            return;
                        }

                        userProfile.tier = 'plus';
                        userProfile.requestsToday = 0;
                        userProfile.plusKey = key;
                        userProfile.plusActivationDate = new Date().toISOString();
                        const expiryDate = new Date();
                        expiryDate.setMonth(expiryDate.getMonth() + 1);
                        userProfile.plusKeyExpiry = expiryDate.toISOString();
                        
                        usedKeys[key] = userProfile.plusKeyExpiry;
                        localStorage.setItem('starx_used_plus_keys', JSON.stringify(usedKeys));

                        saveUserProfile();
                        updateUIForUserTier();
                        showAlertModal('Nâng cấp thành công!', 'Tài khoản của bạn đã được nâng cấp lên gói Plus. Bạn có 2 ngày sử dụng với giới hạn cao hơn và AI thông minh hơn. Gói sẽ hết hạn sau 1 tháng.');
                        return;
                    }
                }
                showAlertModal('Lỗi', 'Pass-Key không hợp lệ. Vui lòng thử lại.');
            }

            function updateUIForUserTier() {
                if (userProfile.tier === 'admin') {
                    intelligenceControl.style.display = 'block';
                    upgradeBtn.style.display = 'none';
                } else {
                    intelligenceControl.style.display = 'none';
                    upgradeBtn.style.display = 'flex';
                }
            }

            // Deep Think dropdown handler
            deepThinkBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deepThinkMenu.classList.toggle('visible');
            });

            document.querySelectorAll('.deep-think-option').forEach(option => {
                option.addEventListener('click', () => {
                    const selectedMode = option.dataset.mode;
                    document.querySelectorAll('.deep-think-option').forEach(opt => opt.classList.remove('active'));

                    if (deepThinkMode === selectedMode) {
                        // If clicking the active mode, turn it off
                        deepThinkMode = 'off';
                        deepThinkBtn.classList.remove('active');
                    } else {
                        // Otherwise, switch to the new mode
                        deepThinkMode = selectedMode;
                        option.classList.add('active');
                        deepThinkBtn.classList.add('active');
                    }
                    deepThinkMenu.classList.remove('visible');
                });
            });

            // Intelligence slider handler
            intelligenceBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                intelligenceMenu.classList.toggle('visible');
            });

            intelligenceSlider.addEventListener('input', (e) => {
                aiIntelligence = parseInt(e.target.value, 10);
                intelligenceValue.textContent = aiIntelligence;
            });

            document.addEventListener('click', (e) => {
                if (deepThinkMenu.classList.contains('visible') && !deepThinkBtn.contains(e.target) && !deepThinkMenu.contains(e.target)) {
                    deepThinkMenu.classList.remove('visible');
                }
                if (intelligenceMenu.classList.contains('visible') && !intelligenceBtn.contains(e.target) && !intelligenceMenu.contains(e.target)) {
                    intelligenceMenu.classList.remove('visible');
                }
            });

            // Upgrade button handler
            upgradeBtn.addEventListener('click', () => {
                passkeyModalOverlay.classList.add('visible');
                passkeyInput.focus();
            });

            function closePasskeyModal() {
                passkeyModalOverlay.classList.remove('visible');
                passkeyInput.value = '';
            }

            cancelPasskeyBtn.addEventListener('click', closePasskeyModal);
            passkeyModalOverlay.addEventListener('click', (e) => {
                if (e.target === passkeyModalOverlay) {
                    closePasskeyModal();
                }
            });

            // Event delegation for panel toggle buttons
            chatContainer.addEventListener('click', function(e) {
                const toggleBtn = e.target.closest('.panel-toggle-btn');
                if (toggleBtn) {
                    const panelContent = toggleBtn.closest('.ai-panel-content');
                    const panelBody = panelContent.querySelector('.panel-body');
                    if (panelBody) {
                        toggleBtn.classList.toggle('collapsed');
                        panelBody.classList.toggle('collapsed');
                    }
                }
            });

            // Event delegation for chat history actions (rename, delete)
            chatHistoryContainer.addEventListener('click', function(e) {
                const deleteBtn = e.target.closest('.delete-btn');
                const renameBtn = e.target.closest('.rename-btn');

                if (deleteBtn) {
                    e.stopPropagation();
                    const chatItem = deleteBtn.closest('.chat-item');
                    const convoId = chatItem.dataset.id;
                    handleDeleteConversation(convoId);
                }

                if (renameBtn) {
                    e.stopPropagation();
                    const chatItem = renameBtn.closest('.chat-item');
                    const convoId = chatItem.dataset.id;
                    handleRenameConversation(convoId, chatItem);
                }
            });

            // Toggle Internet Search mode
            internetSearchBtn.addEventListener('click', () => {
                isInternetSearchMode = !isInternetSearchMode;
                internetSearchBtn.classList.toggle('active', isInternetSearchMode);
            });

            // Handle In-depth Research button
            researchBtn.addEventListener('click', () => {
                // Tắt các chế độ khác khi bắt đầu nghiên cứu
                isInternetSearchMode = false;
                internetSearchBtn.classList.remove('active');
                deepThinkMode = 'off';
                deepThinkBtn.classList.remove('active');
                document.querySelectorAll('.deep-think-option').forEach(opt => opt.classList.remove('active'));

                researchModalOverlay.classList.add('visible');
                setTimeout(() => researchTopicInput.focus(), 100); // Focus input after transition
            });

            // Handle closing the research modal
            function closeResearchModal() {
                researchModalOverlay.classList.remove('visible');
            }

            cancelResearchBtn.addEventListener('click', closeResearchModal);

            researchModalOverlay.addEventListener('click', (e) => {
                if (e.target === researchModalOverlay) {
                    closeResearchModal();
                }
            });

            // --- Alert Modal Logic ---
            function showAlertModal(title, message) {
                alertModalTitle.textContent = title;
                alertModalMessage.textContent = message;
                alertModalOverlay.classList.add('visible');
            }

            function hideAlertModal() {
                alertModalOverlay.classList.remove('visible');
            }

            alertModalOkBtn.addEventListener('click', hideAlertModal);

            alertModalOverlay.addEventListener('click', (e) => {
                if (e.target === alertModalOverlay) {
                    hideAlertModal();
                }
            });

            // --- Confirmation Modal Logic ---
            let onConfirmCallback = null;

            function showConfirmationModal(title, message, confirmText, onConfirm) {
                confirmationModalTitle.textContent = title;
                confirmationModalMessage.textContent = message;
                confirmActionBtn.textContent = confirmText;

                // Style for destructive action
                confirmActionBtn.classList.remove('modal-btn-primary');
                confirmActionBtn.classList.add('modal-btn-danger');

                onConfirmCallback = onConfirm;
                confirmationModalOverlay.classList.add('visible');
            }

            function hideConfirmationModal() {
                confirmationModalOverlay.classList.remove('visible');
                onConfirmCallback = null;
            }

            cancelConfirmationBtn.addEventListener('click', hideConfirmationModal);

            confirmActionBtn.addEventListener('click', () => {
                if (typeof onConfirmCallback === 'function') {
                    onConfirmCallback();
                }
                hideConfirmationModal();
            });

            confirmationModalOverlay.addEventListener('click', (e) => {
                if (e.target === confirmationModalOverlay) {
                    hideConfirmationModal();
                }
            });

            document.addEventListener('keydown', (e) => { // Combined Escape key handler
                if (e.key === 'Escape') {
                    if (researchModalOverlay.classList.contains('visible')) {
                        closeResearchModal();
                    }
                    if (confirmationModalOverlay.classList.contains('visible')) {
                        hideConfirmationModal();
                    }
                    if (alertModalOverlay.classList.contains('visible')) {
                        hideAlertModal();
                    }
                }
            });

            // Handle passkey form submission
            passkeyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const key = passkeyInput.value.trim();
                if (!key) return;

                handlePasskey(key);
                closePasskeyModal();
            });


            // Handle research form submission
            researchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const topic = researchTopicInput.value.trim();
                if (topic) {
                    handleInDepthResearch(topic);
                    researchTopicInput.value = ''; // Clear input
                    closeResearchModal();
                }
            });
            
            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                const wasScrolledToBottom = chatContainer.scrollHeight - chatContainer.clientHeight <= chatContainer.scrollTop + 1;

                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 300) + 'px';

                // If the user was at the bottom, keep them there after the input resizes
                if (wasScrolledToBottom) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }

                // Enable/disable send button based on input
                sendBtn.disabled = this.value.trim() === '' && !uploadedFile;
            });
            
            // Handle file upload
            fileUpload.addEventListener('change', async function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    
                    fileStatusText.textContent = `Đang xử lý file: ${file.name}...`;
                    fileStatusIndicator.style.display = 'flex';
                    chatContainer.scrollTop = chatContainer.scrollHeight;

                    try {
                        const fileData = await readFile(file);
                        uploadedFile = {
                            file: file,
                            data: fileData
                        };
                        
                        // Cập nhật trạng thái với thông báo và xem trước
                        let statusHTML = `Đã sẵn sàng để gửi file: <strong>${file.name}</strong> (${formatFileSize(file.size)}).`;
                        if (fileData.type === 'image') {
                            statusHTML += `<br><img src="${fileData.url}" class="file-preview">`;
                        }
                        fileStatusText.innerHTML = statusHTML;
                        
                        sendBtn.disabled = false; // Bật nút gửi ngay khi file sẵn sàng
                        chatContainer.scrollTop = chatContainer.scrollHeight;

                    } catch (error) {
                        console.error('Error reading file:', error);
                        fileStatusText.innerHTML = `<span style="color: red;">Lỗi: ${error}. Vui lòng thử lại.</span>`;
                        // Ẩn sau vài giây
                        setTimeout(() => {
                            fileStatusIndicator.style.display = 'none';
                        }, 5000);
                        uploadedFile = null;
                        fileUpload.value = '';
                    }
                }
            });
            
            // Send message on Enter (without Shift on desktop, with Shift on mobile)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const isMobile = window.innerWidth <= 768;
                    if ((!isMobile && !e.shiftKey) || (isMobile && e.shiftKey)) {
                        e.preventDefault();
                        if (!sendBtn.disabled) {
                            sendMessage();
                        }
                    }
                }
            });
            
            // Send message on button click
            sendBtn.addEventListener('click', sendMessage);
            
            // Scroll to bottom button
            scrollToBottomBtn.addEventListener('click', function() {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
            
            // Show/hide scroll to bottom button based on scroll position
            chatContainer.addEventListener('scroll', function() {
                const scrollThreshold = 100;
                const isNearBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < scrollThreshold;
                
                if (isNearBottom) {
                    scrollToBottomBtn.classList.remove('visible');
                } else {
                    scrollToBottomBtn.classList.add('visible');
                }
            });
            
            // Function to fetch with API key rotation and retry mechanism
            async function fetchWithApiKeyRotation(endpoint, payload, retriesPerKey = 2, backoff = 1000) {
                const initialKeyIndex = currentApiKeyIndex;
                let totalAttempts = 0;
                const maxTotalAttempts = API_KEYS.length * (retriesPerKey + 1); // Maximum possible attempts
                let rateLimitFailures = 0; // Track how many keys fail due to rate limits in a cycle

                while (totalAttempts < maxTotalAttempts) {
                    const apiKey = API_KEYS[currentApiKeyIndex];
                    let keyFailedDueToRateLimit = false;
                    const url = `${endpoint}?key=${apiKey}`;
                    totalAttempts++;

                    for (let i = 0; i <= retriesPerKey; i++) {
                        try {
                            const response = await fetch(url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });

                            if (response.ok) {
                                return response; // Success!
                            }

                            if (response.status === 429) { // Rate limited
                                console.warn(`API key index ${currentApiKeyIndex} is rate-limited. Switching to next key.`);
                                keyFailedDueToRateLimit = true;
                                break; // Break inner loop to switch key
                            }
                            
                            if ([500, 502, 503, 504].includes(response.status)) {
                                if (i < retriesPerKey) {
                                    console.warn(`Server error ${response.status} on key index ${currentApiKeyIndex}. Retrying in ${backoff * (i + 1)}ms...`);
                                    await new Promise(resolve => setTimeout(resolve, backoff * (i + 1)));
                                    continue; // Retry on same key
                                } else {
                                    console.error(`All retries failed for key index ${currentApiKeyIndex} with server error ${response.status}. Switching key.`);
                                    break; 
                                }
                            }

                            const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
                            throw new Error(`Lỗi API (${response.status}): ${errorData.error?.message || response.statusText}`);

                        } catch (error) {
                            if (error.message.startsWith('Lỗi API')) {
                                throw error; 
                            }
                             if (i < retriesPerKey) {
                                console.warn(`Network error on key index ${currentApiKeyIndex}. Retrying...`);
                                await new Promise(resolve => setTimeout(resolve, backoff * (i + 1)));
                                continue;
                            } else {
                                console.error(`All retries failed for key index ${currentApiKeyIndex} with network error. Switching key.`);
                                break;
                            }
                        }
                    }

                    if (keyFailedDueToRateLimit) {
                        rateLimitFailures++;
                    }

                    currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
                    // If we've completed a full cycle through all keys
                    if (currentApiKeyIndex === initialKeyIndex) {
                        if (rateLimitFailures === API_KEYS.length) {
                            // If ALL keys failed due to rate limits, it's a temporary overload issue, not a permanent block.
                            throw new Error("Hệ thống đang tạm thời quá tải do lưu lượng truy cập cao. Vui lòng thử lại sau ít phút.");
                        }
                        // Otherwise, it's a general server/network issue across all keys.
                        throw new Error("Tất cả các máy chủ AI dường như đang gặp sự cố. Vui lòng thử lại sau ít phút.");
                    }
                }
                throw new Error("Không thể kết nối đến AI. Vui lòng thử lại sau.");
            }

            function mapIntelligenceToTemp(intelligence) {
                // Maps 0-100 to a temperature range, e.g., 0.1 to 1.5
                // 0 -> 0.1 (more deterministic), 50 -> 0.9 (balanced), 100 -> 1.5 (creative)
                return 0.1 + (intelligence / 100) * 1.4;
            }

            async function fetchWithRetry(url, options, retries = 3, initialBackoff = 1000) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.ok) {
                            return response;
                        }
                        if ([500, 502, 503, 504].includes(response.status)) {
                            throw new Error(`Server error: ${response.status}`);
                        }
                        const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
                        throw new Error(`Lỗi API (${response.status}): ${errorData.error?.message || response.statusText}`);

                    } catch (error) {
                        if (i === retries - 1) {
                            if (error.message && error.message.includes('429')) {
                                throw new Error("Bạn đã đạt giới hạn sử dụng AI. Vui lòng quay lại sau.");
                            }
                            throw new Error("AI không thể phản hồi lúc này. Vui lòng kiểm tra lại kết nối hoặc thử lại sau ít phút.");
                        }
                        await new Promise(resolve => setTimeout(resolve, initialBackoff * (i + 1)));
                    }
                }
            }

            function handleApiError(error, panel = null) {
                console.error('API Error:', error);
                if (panel) panel.style.display = 'none'; // Hide the "thinking" panel if it exists

                // Check for specific, user-facing errors that should be modals
                const rateLimitMessage = "Bạn đã đạt giới hạn sử dụng AI. Vui lòng quay lại sau.";
                const connectionErrorMessage = "AI không thể phản hồi lúc này. Vui lòng kiểm tra lại kết nối hoặc thử lại sau ít phút.";

                if (error.message === rateLimitMessage) {
                    showAlertModal("Lỗi Giới Hạn", error.message);
                } else if (error.message === connectionErrorMessage) {
                    showAlertModal("Lỗi Kết Nối", error.message);
                } else {
                    // For other errors, display them in the chat window
                    addMessage('ai', `Xin lỗi, đã có lỗi xảy ra. ${error.message}`);
                }
            }

            function manageCurrentConversation(userMessage) {
                let currentConvo = conversations.find(c => c.id === currentConversationId);

                if (!currentConvo) {
                    currentConversationId = 'convo-' + Date.now();
                    const title = userMessage.substring(0, 40) + (userMessage.length > 40 ? '...' : '');
                    currentConvo = {
                        id: currentConversationId,
                        title: title || "Cuộc trò chuyện mới",
                        timestamp: Date.now(),
                        messages: []
                    };
                    conversations.unshift(currentConvo); // Add to the top of the list
                    chatHistory = currentConvo.messages;
                    renderChatHistorySidebar();
                } else {
                    currentConvo.timestamp = Date.now(); // Update timestamp to sort by recency
                    chatHistory = currentConvo.messages;
                }
            }

            async function sendMessage() {
                let message = messageInput.value.trim();

                if (checkUsageLimits()) {
                    sendBtn.classList.remove('loading');
                    sendBtn.disabled = messageInput.value.trim() === '' && !uploadedFile;
                    return;
                }
                
                // Ưu tiên kiểm tra chế độ kết hợp
                if (isInternetSearchMode && deepThinkMode !== 'off') {
                    handleCombinedSearchAndThink(message);
                    return;
                }

                // Chuyển hướng đến các trình xử lý chế độ đặc biệt trước
                if (isInternetSearchMode) {
                    handleInternetSearch(message);
                    return;
                }
                if (deepThinkMode !== 'off') {
                    handleDeepThink(message);
                    return;
                }
                // The research mode is initiated by its own button, not here.
                if (researchBtn.classList.contains('active')) {
                    return; // Prevent sending while research is active
                }

                if (message === '' && !uploadedFile) return;

                manageCurrentConversation(message);

                // Ẩn chỉ báo trạng thái file
                fileStatusIndicator.style.display = 'none';

                // Hide empty state if it's the first message
                if (emptyState && emptyState.style.display !== 'none') {
                    emptyState.style.display = 'none';
                }

                // Thêm tin nhắn của người dùng vào giao diện.
                // Hàm addMessage sẽ xử lý việc hiển thị file.
                addMessage('user', message, uploadedFile);

                const userParts = [];
                if (message) {
                    userParts.push({ text: message });
                }
                
                if (uploadedFile) {
                    const fileData = uploadedFile.data;
                    if (fileData.type === 'image') {
                        // Đối với hình ảnh, thêm phần inline_data cho API
                        userParts.push({
                            inline_data: { mime_type: fileData.mimeType, data: fileData.base64 }
                        });
                    } else {
                        // Đối với các tệp khác, hãy tạo một bản tóm tắt văn bản
                        let fileSummary = '';
                        switch(fileData.type) {
                            case 'text':
                                fileSummary = `[Nội dung file ${uploadedFile.file.name}:\n${fileData.content.substring(0, 4000)}...]`;
                                break;
                            case 'powerpoint':
                                const slidesSummary = fileData.slides.map(slide => `- ${slide.title}`).join('\n');
                                fileSummary = `[File PowerPoint: ${uploadedFile.file.name}, ${fileData.slides.length} slides:\n${slidesSummary}]`;
                                break;
                            default:
                                fileSummary = `[File đã tải lên: ${uploadedFile.file.name}, định dạng: ${uploadedFile.file.type}]`;
                        }
                        
                        // Thêm tóm tắt vào trước phần văn bản hiện có hoặc thêm một phần mới
                        if (userParts.length > 0 && userParts[0].text) {
                            userParts[0].text = `${fileSummary}\n\n${userParts[0].text}`;
                        } else {
                            userParts.unshift({ text: fileSummary });
                        }
                    }
                }

                chatHistory.push({ role: 'user', parts: userParts });
                saveConversations();
                
                // Xóa đầu vào và file
                messageInput.value = '';
                messageInput.style.height = 'auto';
                fileUpload.value = '';
                uploadedFile = null;
                sendBtn.disabled = true;
                
                // Hiển thị trạng thái tải
                sendBtn.classList.add('loading');
                typingIndicator.style.display = 'flex';
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                let temperature;
                if (userProfile.tier === 'admin') {
                    temperature = mapIntelligenceToTemp(aiIntelligence);
                } else if (userProfile.tier === 'plus') {
                    temperature = mapIntelligenceToTemp(70);
                } else { // normal user
                    temperature = mapIntelligenceToTemp(50);
                }

                const bodyPayload = {
                    contents: chatHistory,
                    generationConfig: {
                        temperature: temperature,
                        topK: 1,
                        topP: 1,
                        maxOutputTokens: 4096,
                        stopSequences: []
                    },
                    safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" } ]
                };

                const lowerCaseMessage = message.toLowerCase();
                const searchKeywords = ['hôm nay', 'ngày mấy', 'tháng mấy', 'bây giờ', 'hiện tại', 'mới nhất', 'gần đây', 'thời tiết', 'giá cổ phiếu', 'tỷ giá'];
                const autoSearch = searchKeywords.some(keyword => lowerCaseMessage.includes(keyword));

                // Tự động tìm kiếm "âm thầm" khi không ở chế độ tìm kiếm chuyên dụng
                if (autoSearch) {
                    const searchResult = await performInternetSearch(message, false); // false = không hiển thị UI
                    let searchResultsContext = '';
                    if (searchResult.error) {
                        searchResultsContext = searchResult.error;
                    } else if (searchResult.items.length > 0) {
                        const context = searchResult.items.slice(0, 3).map((item, index) => `Kết quả ${index + 1}:\n- Tiêu đề: ${item.title}\n- Đoạn trích: ${item.snippet}`).join('\n\n');
                        searchResultsContext = `[Dưới đây là các kết quả tìm kiếm trên Internet để tham khảo:\n\n${context}\n]`;
                    }

                    if (searchResultsContext) {
                        // Thêm bối cảnh tìm kiếm vào trước tin nhắn của người dùng
                        if (userParts.length > 0 && userParts[0].text) {
                            userParts[0].text = `${searchResultsContext}\n\n---\n\nDựa vào thông tin trên, hãy trả lời câu hỏi sau: ${userParts[0].text}`;
                        } else {
                            userParts.unshift({ text: searchResultsContext });
                        }
                        chatHistory[chatHistory.length - 1].parts = userParts;
                    }
                }

                try {
                    userProfile.requestsToday++;
                    const response = await fetchWithApiKeyRotation(API_ENDPOINT, bodyPayload);
                    
                    const data = await response.json();
                    
                    typingIndicator.style.display = 'none';
                    
                    const candidate = data.candidates?.[0];
                    if (candidate?.content?.parts?.[0]?.text) {
                        const aiResponse = candidate.content.parts[0].text;
                        await addMessageWithTypingEffect('ai', aiResponse);
                        chatHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
                        saveConversations();
                    } else {
                        console.error("API Error Response:", data);
                        let errorMessage = "Xin lỗi, tôi gặp sự cố khi xử lý yêu cầu của bạn. Vui lòng thử lại.";
                        if (candidate?.finishReason && candidate.finishReason !== "STOP") {
                            errorMessage = `Yêu cầu đã bị dừng với lý do: ${candidate.finishReason}.`;
                            if (data.promptFeedback?.blockReason) {
                                errorMessage += ` Chi tiết: ${data.promptFeedback.blockReason}.`;
                            }
                        }
                        addMessage('ai', errorMessage);
                    }
                } catch (error) {
                    // Use the centralized error handler
                    handleApiError(error);
                } finally {
                    sendBtn.classList.remove('loading');
                    typingIndicator.style.display = 'none';
                    sendBtn.disabled = messageInput.value.trim() === '' && !uploadedFile;
                    saveUserProfile();
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }

            function createCombinedPanel() {
                const panelDiv = document.createElement('div');
                panelDiv.className = 'message message-ai combined-panel';
                panelDiv.innerHTML = `
                    <div class="message-user">
                        <div class="message-avatar message-ai">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" /></svg>
                            </div>
                            <div class="message-content ai-panel-content">
                            <div class="deep-think-header">
                                <div class="deep-think-header-main">
                                    <h3>
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20" style="margin-left: -8px; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"></path></svg>
                                        Searching & Thinking...
                                    </h3>
                                    <div class="deep-think-timer">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        <span class="deep-think-timer-value">0s</span>
                                    </div>
                                </div>
                                <button class="panel-toggle-btn" title="Ẩn/Hiện chi tiết"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg></button>
                            </div>
                            <div class="panel-body">
                                <div class="deep-think-section"><h4>Bước 1: Tìm kiếm trên Internet</h4><div class="search-results-content">Đang khởi tạo...</div></div>
                                <div class="deep-think-section"><h4>Bước 2: Quá trình suy nghĩ</h4><div class="thought-process-content">Đang chờ kết quả tìm kiếm...</div></div>
                            </div>
                        </div>
                    </div>
                `;
                return panelDiv;
            }

            async function handleCombinedSearchAndThink(message) {
                if (checkUsageLimits()) {
                    sendBtn.classList.remove('loading');
                    sendBtn.disabled = messageInput.value.trim() === '' && !uploadedFile;
                    return;
                }

                if (message === '' && !uploadedFile) return;

                // Bật trạng thái tải
                sendBtn.disabled = true;
                sendBtn.classList.add('loading');

                // Hide empty state and file status
                fileStatusIndicator.style.display = 'none';
                if (emptyState && emptyState.style.display !== 'none') {
                    emptyState.style.display = 'none';
                }

                addMessage('user', message, uploadedFile);

                const userParts = [];
                if (message) userParts.push({ text: message });
                chatHistory.push({ role: 'user', parts: userParts });
                saveConversations();

                messageInput.value = '';
                messageInput.style.height = 'auto';
                fileUpload.value = '';
                uploadedFile = null;

                const panel = createCombinedPanel();
                chatContainer.insertBefore(panel, typingIndicator);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                try {
                    const timerElement = panel.querySelector('.deep-think-timer-value');
                    startTimer(timerElement);

                    // --- Step 1: Internet Search ---
                    const searchResultsContainer = panel.querySelector('.search-results-content');
                    searchResultsContainer.innerHTML = ''; // Clear "Đang khởi tạo..."
                    const searchResult = await performInternetSearch(message, true); // true = show UI elements within the panel

                    let searchContext = '';
                    if (searchResult.error) {
                        searchResultsContainer.innerHTML = `<p style="color: var(--text-secondary);">${searchResult.error}</p>`;
                        searchContext = searchResult.error;
                    } else if (searchResult.items.length > 0) {
                        searchResult.items.slice(0, 5).forEach(item => {
                            const resultDiv = document.createElement('div');
                            resultDiv.className = 'search-result-item';
                            const faviconUrl = getFaviconUrl(item.link);
                            resultDiv.innerHTML = `
                                <img src="${faviconUrl}" class="search-result-favicon" alt="" onerror="this.style.display='none'">
                                <div>
                                    <a href="${item.link}" target="_blank" rel="noopener noreferrer" class="search-result-title">${item.title}</a>
                                    <p class="search-result-snippet">${item.snippet}</p>
                                </div>
                            `;
                            searchResultsContainer.appendChild(resultDiv);
                        });
                        searchContext = `[Dưới đây là các kết quả tìm kiếm trên Internet để tham khảo:\n\n${searchResult.items.slice(0, 3).map((item, index) => `Kết quả ${index + 1}:\n- Tiêu đề: ${item.title}\n- Đoạn trích: ${item.snippet}`).join('\n\n')}\n]`;
                    } else {
                        searchResultsContainer.innerHTML = `<p style="color: var(--text-secondary);">Không tìm thấy kết quả nào.</p>`;
                        searchContext = "[Không tìm thấy kết quả nào trên Internet.]";
                    }
                    chatContainer.scrollTop = chatContainer.scrollHeight;

                    // --- Step 2: Deep Think Simulation ---
                    const thoughtProcessElement = panel.querySelector('.thought-process-content');
                    thoughtProcessElement.innerHTML = ''; // Clear "Đang chờ..."
                    
                    // Choose the right thinking simulation
                    if (deepThinkMode === 'deepest') {
                        await simulateDeepestThinkingProcess(thoughtProcessElement);
                    } else if (deepThinkMode === 'deeper') {
                        await simulateDeeperThinkingProcess(thoughtProcessElement);
                    } else { // 'normal'
                        await simulateThinkingProcess(thoughtProcessElement);
                    }

                    // --- Final API Call ---
                    clearInterval(deepThinkTimerInterval);
                    const panelHeader = panel.querySelector('.deep-think-header h3');
                    panelHeader.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Đã hoàn tất`;

                    const toggleBtn = panel.querySelector('.panel-toggle-btn');
                    const panelBody = panel.querySelector('.panel-body');
                    toggleBtn?.classList.add('collapsed');
                    panelBody?.classList.add('collapsed');

                    // Prepend context to the last user message
                    const lastUserMessage = chatHistory[chatHistory.length - 1];
                    const finalPrompt = `${searchContext}\n\n---\n\nDựa vào thông tin trên và suy nghĩ một cách sâu sắc, hãy trả lời câu hỏi sau: ${lastUserMessage.parts[0].text}`;
                    lastUserMessage.parts[0].text = finalPrompt;

                    let temperature = userProfile.tier === 'admin' ? mapIntelligenceToTemp(aiIntelligence) : (userProfile.tier === 'plus' ? mapIntelligenceToTemp(70) : mapIntelligenceToTemp(50));

                    const bodyPayload = {
                        contents: chatHistory,
                        generationConfig: { 
                            temperature: temperature, 
                            topK: 1, 
                            topP: 1, 
                            maxOutputTokens: 8192 
                        },
                        safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" } ]
                    };

                    userProfile.requestsToday++;
                    const response = await fetchWithApiKeyRotation(API_ENDPOINT, bodyPayload);

                    const data = await response.json();
                    const candidate = data.candidates?.[0];

                    if (candidate?.content?.parts?.[0]?.text) {
                        const aiResponse = candidate.content.parts[0].text;
                        await addMessageWithTypingEffect('ai', aiResponse);
                        chatHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
                        saveConversations();
                    } else {
                        throw new Error("Không nhận được phản hồi hợp lệ từ AI sau khi kết hợp tìm kiếm và suy nghĩ.");
                    }

                } catch (error) {
                    clearInterval(deepThinkTimerInterval);
                    // Use the centralized error handler
                    handleApiError(error, panel);
                } finally {
                    // Reset both modes
                    isInternetSearchMode = false;
                    internetSearchBtn.classList.remove('active');
                    deepThinkMode = 'off';
                    deepThinkBtn.classList.remove('active');
                    document.querySelectorAll('.deep-think-option').forEach(opt => opt.classList.remove('active'));

                    // Tắt trạng thái tải
                    sendBtn.classList.remove('loading');
                    sendBtn.disabled = messageInput.value.trim() === '' && !uploadedFile;
                    saveUserProfile();
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }

            async function handleInternetSearch(message) {
                if (checkUsageLimits()) {
                    sendBtn.classList.remove('loading');
                    sendBtn.disabled = messageInput.value.trim() === '' && !uploadedFile;
                    return;
                }

                if (message === '' && !uploadedFile) return;

                manageCurrentConversation(message);

                // Bật trạng thái tải
                sendBtn.disabled = true;
                sendBtn.classList.add('loading');

                fileStatusIndicator.style.display = 'none';
                if (emptyState && emptyState.style.display !== 'none') {
                    emptyState.style.display = 'none';
                }

                addMessage('user', message, uploadedFile);

                const userParts = [];
                if (message) userParts.push({ text: message });
                chatHistory.push({ role: 'user', parts: userParts });
                saveConversations();

                messageInput.value = '';
                messageInput.style.height = 'auto';
                fileUpload.value = '';
                uploadedFile = null;

                const panel = createSearchPanel();
                chatContainer.insertBefore(panel, typingIndicator);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                const timerElement = panel.querySelector('.deep-think-timer-value');
                startTimer(timerElement);

                // --- Step 1: Fetch and display results ---
                const step1Container = panel.querySelector('.search-results-content');
                const searchResult = await performInternetSearch(message, true); // true = show UI

                let searchContext = '';
                if (searchResult.error) {
                    step1Container.innerHTML = `<p style="color: var(--text-secondary);">${searchResult.error}</p>`;
                    searchContext = searchResult.error;
                } else if (searchResult.items.length > 0) {
                    searchResult.items.slice(0, 5).forEach(item => { // Show up to 5 results
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'search-result-item';
                        const faviconUrl = getFaviconUrl(item.link);
                        resultDiv.innerHTML = `
                            <img src="${faviconUrl}" class="search-result-favicon" alt="" onerror="this.style.display='none'">
                            <div>
                                <a href="${item.link}" target="_blank" rel="noopener noreferrer" class="search-result-title">${item.title}</a>
                                <p class="search-result-snippet">${item.snippet}</p>
                            </div>
                        `;
                        step1Container.appendChild(resultDiv);
                    });
                    // Build context for AI from top 3 results
                    searchContext = `[Dưới đây là các kết quả tìm kiếm trên Internet để tham khảo:\n\n${searchResult.items.slice(0, 3).map((item, index) => `Kết quả ${index + 1}:\n- Tiêu đề: ${item.title}\n- Đoạn trích: ${item.snippet}`).join('\n\n')}\n]`;
                } else {
                    step1Container.innerHTML = `<p style="color: var(--text-secondary);">Không tìm thấy kết quả nào.</p>`;
                    searchContext = "[Không tìm thấy kết quả nào trên Internet.]";
                }
                chatContainer.scrollTop = chatContainer.scrollHeight;

                // --- Step 2 & 3: Simulate analysis ---
                const simulatedStepsContainer = panel.querySelector('.simulated-steps-content');
                await new Promise(resolve => setTimeout(resolve, 1000));
                const step2Div = document.createElement('div');
                step2Div.className = 'thought-step';
                step2Div.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> <span>Phân loại và loại bỏ các kết quả không liên quan.</span>`;
                simulatedStepsContainer.appendChild(step2Div);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                await new Promise(resolve => setTimeout(resolve, 800));
                const step3Div = document.createElement('div');
                step3Div.className = 'thought-step';
                step3Div.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> <span>Chọn các kết quả đáng tin cậy nhất để tạo bối cảnh.</span>`;
                simulatedStepsContainer.appendChild(step3Div);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                // --- Final API Call ---
                clearInterval(deepThinkTimerInterval);
                const panelHeader = panel.querySelector('.search-panel-header h3, .deep-think-header h3');
                panelHeader.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Đã hoàn tất tìm kiếm`;

                // Collapse the panel details, but allow user to re-open
                const toggleBtn = panel.querySelector('.panel-toggle-btn');
                const panelBody = panel.querySelector('.panel-body');
                toggleBtn?.classList.add('collapsed');
                panelBody?.classList.add('collapsed');

                // Prepend context to the last user message in chat history
                const lastUserMessage = chatHistory[chatHistory.length - 1];
                if (lastUserMessage.parts.length > 0 && lastUserMessage.parts[0].text) {
                    lastUserMessage.parts[0].text = `${searchContext}\n\n---\n\nDựa vào thông tin trên, hãy trả lời câu hỏi sau: ${lastUserMessage.parts[0].text}`;
                } else {
                    lastUserMessage.parts.unshift({ text: searchContext });
                }

                let temperature = userProfile.tier === 'admin' ? mapIntelligenceToTemp(aiIntelligence) : (userProfile.tier === 'plus' ? mapIntelligenceToTemp(70) : mapIntelligenceToTemp(50));

                const bodyPayload = {
                    contents: chatHistory,
                    generationConfig: { 
                        temperature: temperature, 
                        topK: 1, 
                        topP: 1, 
                        maxOutputTokens: 8192 
                    },
                    safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" } ]
                };

                try {
                    userProfile.requestsToday++;
                    const response = await fetchWithApiKeyRotation(API_ENDPOINT, bodyPayload);
                    const data = await response.json();
                    const candidate = data.candidates?.[0];

                    if (candidate?.content?.parts?.[0]?.text) {
                        const aiResponse = candidate.content.parts[0].text;
                        await addMessageWithTypingEffect('ai', aiResponse);
                        chatHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
                        saveConversations();
                    } else {
                        // Handle safety blocks or other reasons
                        throw new Error("Không nhận được phản hồi hợp lệ từ AI.");
                    }
                } catch (error) { // Use the centralized error handler
                    clearInterval(deepThinkTimerInterval);
                    handleApiError(error, panel);
                } finally {
                    // Reset the mode after use
                    isInternetSearchMode = false;
                    internetSearchBtn.classList.remove('active');

                    // Tắt trạng thái tải
                    sendBtn.classList.remove('loading');
                    sendBtn.disabled = messageInput.value.trim() === '' && !uploadedFile;
                    saveUserProfile();
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }

            async function handleDeepThink(message) {
                if (checkUsageLimits()) {
                    sendBtn.classList.remove('loading');
                    sendBtn.disabled = messageInput.value.trim() === '' && !uploadedFile;
                    return;
                }

                if (message === '' && !uploadedFile) return;

                manageCurrentConversation(message);

                // Bật trạng thái tải
                sendBtn.disabled = true;
                sendBtn.classList.add('loading');

                // Hide empty state and file status
                fileStatusIndicator.style.display = 'none';
                if (emptyState && emptyState.style.display !== 'none') {
                    emptyState.style.display = 'none';
                }

                addMessage('user', message, uploadedFile);

                const userParts = [];
                if (message) userParts.push({ text: message });
                chatHistory.push({ role: 'user', parts: userParts });
                saveConversations();

                messageInput.value = '';
                messageInput.style.height = 'auto';
                fileUpload.value = '';
                uploadedFile = null;

                const panel = createDeepThinkPanel();
                chatContainer.insertBefore(panel, typingIndicator);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                try {
                    const timerElement = panel.querySelector('.deep-think-timer-value');
                    const thoughtProcessElement = panel.querySelector('.thought-process-content');
                    
                    startTimer(timerElement);

                    if (deepThinkMode === 'deepest') {
                        panel.querySelector('.deep-think-header h3').innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"></path>
                            </svg> Deepest Thinking...
                        `;
                        await simulateDeepestThinkingProcess(thoughtProcessElement);
                    } else if (deepThinkMode === 'deeper') {
                        panel.querySelector('.deep-think-header h3').innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"></path>
                            </svg> Deeper Thinking...
                        `;
                        await simulateDeeperThinkingProcess(thoughtProcessElement);
                    } else { // 'normal'
                        await simulateThinkingProcess(thoughtProcessElement);
                    }

                    let temperature = userProfile.tier === 'admin' ? mapIntelligenceToTemp(aiIntelligence) : (userProfile.tier === 'plus' ? mapIntelligenceToTemp(70) : mapIntelligenceToTemp(50));

                    const bodyPayload = {
                        contents: chatHistory,
                        generationConfig: { 
                            temperature: temperature, 
                            topK: 1, 
                            topP: 1, 
                            maxOutputTokens: 8192 
                        }, // Increased tokens for detailed answers
                        safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" } ]
                    };

                    const lowerCaseMessage = message.toLowerCase();
                    const searchKeywords = ['hôm nay', 'ngày mấy', 'tháng mấy', 'bây giờ', 'hiện tại', 'mới nhất', 'gần đây', 'thời tiết', 'giá cổ phiếu', 'tỷ giá'];
                    const autoSearch = searchKeywords.some(keyword => lowerCaseMessage.includes(keyword));

                    // Deep Think can also use silent search
                    if (autoSearch) { /* Logic tương tự sendMessage có thể được thêm vào đây nếu muốn */ }

                    userProfile.requestsToday++;
                    const response = await fetchWithApiKeyRotation(API_ENDPOINT, bodyPayload);
                    const data = await response.json();
                    
                    clearInterval(deepThinkTimerInterval);

                    const candidate = data.candidates?.[0];
                    if (candidate?.content?.parts?.[0]?.text) {
                        const aiResponse = candidate.content.parts[0].text;
                        const panelHeader = panel.querySelector('.deep-think-header h3');
                        panelHeader.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Đã hoàn tất suy nghĩ`;
                        
                        // Collapse the panel details, but allow user to re-open
                        const toggleBtn = panel.querySelector('.panel-toggle-btn');
                        const panelBody = panel.querySelector('.panel-body');
                        toggleBtn?.classList.add('collapsed');
                        panelBody?.classList.add('collapsed');

                        // Thêm câu trả lời như một tin nhắn trò chuyện bình thường bên ngoài panel
                        await addMessageWithTypingEffect('ai', aiResponse);
                        
                        chatHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
                        saveConversations();
                    } else {
                        console.error("Deep Think API Error Response:", data);
                        let errorMessage = "Không có phản hồi từ AI.";
                        if (candidate?.finishReason && candidate.finishReason !== "STOP") {
                            errorMessage = `Yêu cầu đã bị dừng với lý do: ${candidate.finishReason}.`;
                            if (data.promptFeedback?.blockReason) {
                                errorMessage += ` Chi tiết: ${data.promptFeedback.blockReason}.`;
                            }
                        }
                        throw new Error(errorMessage);
                    }
                } catch (error) {
                    clearInterval(deepThinkTimerInterval); // Use the centralized error handler
                    handleApiError(error, panel);
                } finally {
                    // Reset the mode after use
                    deepThinkMode = 'off';
                    deepThinkBtn.classList.remove('active');
                    document.querySelectorAll('.deep-think-option').forEach(opt => opt.classList.remove('active'));

                    // Tắt trạng thái tải
                    sendBtn.classList.remove('loading');
                    sendBtn.disabled = messageInput.value.trim() === '' && !uploadedFile;
                    saveUserProfile();
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
            
            async function handleInDepthResearch(topic) {
                if (checkUsageLimits()) {
                    sendBtn.classList.remove('loading');
                    sendBtn.disabled = messageInput.value.trim() === '' && !uploadedFile;
                    return;
                }

                researchBtn.classList.add('active');
                sendBtn.disabled = true;

                // Bật trạng thái tải
                sendBtn.classList.add('loading');

                if (emptyState && emptyState.style.display !== 'none') {
                    emptyState.style.display = 'none';
                }

                manageCurrentConversation(`Chủ đề nghiên cứu: ${topic}`);

                addMessage('user', `Chủ đề nghiên cứu: ${topic}`);
                chatHistory.push({ role: 'user', parts: [{ text: `Thực hiện nghiên cứu chuyên sâu về chủ đề: "${topic}"` }] }); // This is now handled by manageCurrentConversation

                const panel = createResearchPanel();
                chatContainer.insertBefore(panel, typingIndicator);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                const timerElement = panel.querySelector('.deep-think-timer-value');
                startTimer(timerElement);

                try {
                    // --- Phase 1: Web Search ---
                    const step1Content = panel.querySelector('.step-1-content');
                    addThoughtStep(step1Content, "Bắt đầu tìm kiếm thông tin trên web...", true);
                    const searchResult = await performInternetSearch(topic, false);
                    let searchContext = "[Không tìm thấy kết quả tìm kiếm nào.]";
                    if (searchResult.error) {
                        step1Content.innerHTML += `<p style="color:red;">${searchResult.error}</p>`;
                        searchContext = `[Lỗi tìm kiếm: ${searchResult.error}]`;
                    } else if (searchResult.items.length > 0) {
                        addThoughtStep(step1Content, `Tìm thấy ${searchResult.items.length} kết quả. Đang xử lý...`);
                        searchContext = searchResult.items.slice(0, 5).map((item, index) => `Nguồn ${index + 1}: ${item.title}\nNội dung: ${item.snippet}`).join('\n\n');
                    }

                    // --- Phase 2: Information Synthesis (AI Call 1) ---
                    const step2Content = panel.querySelector('.step-2-content');
                    addThoughtStep(step2Content, "Gửi dữ liệu thô cho AI để tổng hợp...", true);
                    userProfile.requestsToday++;
                    const synthesisPrompt = `Dựa trên các kết quả tìm kiếm sau đây về chủ đề "${topic}", hãy tổng hợp các điểm chính, xác định các ý tưởng cốt lõi và loại bỏ thông tin nhiễu. Trả về một bản tóm tắt súc tích.\n\nKẾT QUẢ TÌM KIẾM:\n${searchContext}`;
                    const synthesisResponse = await fetchWithApiKeyRotation(API_ENDPOINT, {
                        contents: [{ parts: [{ text: synthesisPrompt }] }]
                    });
                    const synthesisData = await synthesisResponse.json();
                    const synthesizedText = synthesisData.candidates?.[0]?.content?.parts?.[0]?.text || "[AI không thể tổng hợp thông tin.]";
                    addThoughtStep(step2Content, "Đã nhận được bản tóm tắt từ AI.");

                    // --- Phase 3: Image Search ---
                    const step3Content = panel.querySelector('.step-3-content');
                    addThoughtStep(step3Content, "Tìm kiếm hình ảnh minh họa...", true);
                    const imageResult = await performImageSearch(topic);
                    let imageUrls = [];
                    if (imageResult.items && imageResult.items.length > 0) {
                        imageUrls = imageResult.items.slice(0, 3).map(item => item.link);
                        const gallery = document.createElement('div');
                        gallery.className = 'research-image-gallery';
                        imageUrls.forEach(url => {
                            gallery.innerHTML += `<img src="${url}" class="research-image-thumbnail" alt="Hình ảnh minh họa">`;
                        });
                        step3Content.appendChild(gallery);
                        addThoughtStep(step3Content, `Đã tìm thấy ${imageUrls.length} hình ảnh phù hợp.`);
                    } else {
                        addThoughtStep(step3Content, "Không tìm thấy hình ảnh phù hợp.");
                    }

                    // --- Phase 4: Final Report Generation (AI Call 2) ---
                    const step4Content = panel.querySelector('.step-4-content');
                    addThoughtStep(step4Content, "Soạn thảo báo cáo cuối cùng...", true);
                    const finalPrompt = `Bạn là một trợ lý nghiên cứu AI chuyên sâu. Nhiệm vụ của bạn là tạo ra một báo cáo chi tiết và toàn diện về chủ đề: "${topic}".

**Bối cảnh đã được tổng hợp từ các nguồn trên Internet:**
${synthesizedText}

**Bạn có thể sử dụng các hình ảnh minh họa sau đây trong báo cáo của mình (sử dụng cú pháp Markdown \`!mô tả\`):**
${imageUrls.map(url => `- ${url}`).join('\n')}

**Yêu cầu báo cáo:**
1.  **Cấu trúc rõ ràng:** Sử dụng tiêu đề, danh sách và các định dạng Markdown khác để làm cho báo cáo dễ đọc.
2.  **Sử dụng bảng:** Khi cần so sánh dữ liệu hoặc liệt kê thông tin có cấu trúc, hãy tạo bảng bằng cú pháp Markdown.
3.  **Tích hợp hình ảnh:** Chèn các hình ảnh đã cung cấp vào những vị trí hợp lý trong báo cáo để minh họa cho các điểm quan trọng.
4.  **Phân tích sâu:** Không chỉ liệt kê thông tin, hãy phân tích, so sánh và đưa ra những nhận định, kết luận có giá trị dựa trên bối cảnh đã cho.

Bây giờ, hãy bắt đầu soạn thảo báo cáo chi tiết.`;

                    userProfile.requestsToday++;
                    const finalResponse = await fetchWithApiKeyRotation(API_ENDPOINT, {
                        contents: [{ parts: [{ text: finalPrompt }] }], generationConfig: { maxOutputTokens: 8192 }
                    });
                    const finalData = await finalResponse.json();
                    const finalReport = finalData.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (finalReport) {
                        clearInterval(deepThinkTimerInterval);
                        panel.querySelector('.deep-think-header h3').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Đã hoàn tất nghiên cứu`;

                        // Collapse the panel details, but allow user to re-open
                        const toggleBtn = panel.querySelector('.panel-toggle-btn');
                        const panelBody = panel.querySelector('.panel-body');
                        toggleBtn?.classList.add('collapsed');
                        panelBody?.classList.add('collapsed');

                        // Thêm báo cáo cuối cùng như một tin nhắn trò chuyện bình thường
                        await addMessageWithTypingEffect('ai', finalReport);

                        chatHistory.push({ role: 'model', parts: [{ text: finalReport }] });
                        saveConversations();
                    } else {
                        throw new Error("AI không thể tạo báo cáo cuối cùng.");
                    }

                } catch (error) {
                    clearInterval(deepThinkTimerInterval);
                    // Use the centralized error handler
                    handleApiError(error, panel);
                } finally {
                    researchBtn.classList.remove('active');

                    // Tắt trạng thái tải
                    sendBtn.classList.remove('loading');
                    sendBtn.disabled = messageInput.value.trim() === '' && !uploadedFile;
                    saveUserProfile();
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }

            function addThoughtStep(container, text, isNewSection = false) {
                if (isNewSection) {
                    container.innerHTML = ''; // Clear previous "thinking..." message
                }
                const stepDiv = document.createElement('div');
                stepDiv.className = 'thought-step';
                stepDiv.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> <span>${text}</span>`;
                container.appendChild(stepDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // Function to add message with typing effect
            async function addMessageWithTypingEffect(sender, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message message-${sender}`;
                
                messageDiv.innerHTML = `
                    <div class="message-user">
                        <div class="message-avatar ${sender === 'user' ? 'user-avatar-bg' : 'message-ai'}">
                            ${sender === 'user' ? 
                                '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>' :
                                '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" /></svg>'}
                        </div>
                        <div class="message-content" id="typing-content"></div>
                    </div>
                `;
                
                chatContainer.insertBefore(messageDiv, typingIndicator);
                
                const contentElement = messageDiv.querySelector('.message-content');
                
                // Process content to detect code blocks and markdown
                const processedContent = processContentWithCodeBlocks(content);
                
                // Display content with typing effect
                await typeContent(contentElement, processedContent);
                
                // Add copy functionality to all code blocks
                addCopyFunctionality(messageDiv);
                // Add preview functionality to all code blocks
                addPreviewFunctionality(messageDiv);
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            // Function to process content and identify code blocks and markdown formatting
            function processContentWithCodeBlocks(content) {
                // First process code blocks
                const codeBlockRegex = /```(\w*)\n([\s\S]*?)\n```/g;
                const parts = [];
                let lastIndex = 0;
                let match;
                
                while ((match = codeBlockRegex.exec(content)) !== null) {
                    // Add text before code block (with markdown processing)
                    if (match.index > lastIndex) {
                        parts.push({
                            type: 'text',
                            content: processMarkdown(content.substring(lastIndex, match.index))
                        });
                    }
                    
                    // Add code block (without markdown processing inside code)
                    const language = match[1] || '';
                    const code = match[2];
                    parts.push({
                        type: 'code',
                        language: language,
                        content: code
                    });
                    
                    lastIndex = match.index + match[0].length;
                }
                
                // Add remaining text after last code block (with markdown processing)
                if (lastIndex < content.length) {
                    parts.push({
                        type: 'text',
                        content: processMarkdown(content.substring(lastIndex))
                    });
                }
                
                // If no code blocks found, process entire content as markdown
                if (parts.length === 0) {
                    parts.push({
                        type: 'text',
                        content: processMarkdown(content)
                    });
                }
                
                return parts;
            }
            
            // Function to process markdown formatting
            function processMarkdown(text) {
                const tables = [];
                const tablePlaceholder = (index) => `__TABLE_PLACEHOLDER_${index}__`;

                // 1. Extract tables and replace with placeholders
                const tableRegex = /^ *\|(.+)\|\n *\|( *[-:]+[-| :]*)\|\n((?: *\|.*(?:\n|$))*)/gm;
                text = text.replace(tableRegex, (match, headerLine, separatorLine, bodyLines) => {
                    const processCell = (cellText) => {
                        return cellText.trim()
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/__(.*?)__/g, '<strong>$1</strong>')
                            .replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/_(.*?)_/g, '<em>$1</em>')
                            .replace(/`([^`\n]+)`/g, '<code>$1</code>')
                            .replace(/~~(.*?)~~/g, '<del>$1</del>');
                    };

                    const align = separatorLine.split('|').slice(1, -1).map(s => {
                        const trimmed = s.trim();
                        if (trimmed.startsWith(':') && trimmed.endsWith(':')) return 'center';
                        if (trimmed.endsWith(':')) return 'right';
                        if (trimmed.startsWith(':')) return 'left';
                        return '';
                    });

                    let tableHtml = '<table>';
                    const headers = headerLine.split('|').slice(1, -1);
                    tableHtml += '<thead><tr>';
                    headers.forEach((header, i) => {
                        tableHtml += `<th${align[i] ? ` style="text-align:${align[i]}"` : ''}>${processCell(header)}</th>`;
                    });
                    tableHtml += '</tr></thead>';

                    tableHtml += '<tbody>';
                    const rows = bodyLines.trim().split('\n');
                    rows.forEach(rowLine => {
                        if (!rowLine.trim()) return;
                        const cells = rowLine.split('|').slice(1, -1);
                        tableHtml += '<tr>';
                        for (let i = 0; i < headers.length; i++) {
                            const cell = cells[i] || '';
                            tableHtml += `<td${align[i] ? ` style="text-align:${align[i]}"` : ''}>${processCell(cell)}</td>`;
                        }
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</tbody></table>';
                    
                    tables.push(tableHtml);
                    return tablePlaceholder(tables.length - 1);
                });

                // Inline code `...`
                // Processed first to prevent markdown characters inside from being interpreted.
                text = text.replace(/`([^`\n]+)`/g, '<code>$1</code>');

                // Images: !alt text
                text = text.replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1" style="max-width: 100%; border-radius: var(--border-radius-md); margin: 10px 0;">');
                
                // Process line breaks BEFORE re-inserting tables and processing other markdown
                text = text.replace(/\n/g, '<br>');
                
                // Re-insert the HTML tables.
                tables.forEach((tableHtml, index) => {
                    // Replace the placeholder with the generated table HTML.
                    // This is done after converting newlines to <br> but before other markdown
                    // to prevent the placeholder from being mangled.
                    text = text.replace(tablePlaceholder(index), tableHtml);
                });

                // Now process other markdown on the text that no longer contains table placeholders.
                // Bold and Italic (***...*** or ___...___)
                text = text.replace(/\*\*\*(\S(?:.|\n)*?\S)\*\*\*/g, '<strong><em>$1</em></strong>')
                           .replace(/___(\S(?:.|\n)*?\S)___/g, '<strong><em>$1</em></strong>');

                // Bold (**...** or __...__)
                text = text.replace(/\*\*(\S(?:.|\n)*?\S)\*\*/g, '<strong>$1</strong>')
                           .replace(/__(\S(?:.|\n)*?\S)__/g, '<strong>$1</strong>');

                // Italic (*...* or _..._)
                text = text.replace(/\*(\S(?:.|\n)*?\S)\*/g, '<em>$1</em>')
                           .replace(/_(\S(?:.|\n)*?\S)_/g, '<em>$1</em>');

                // Strikethrough (~~...~~)
                text = text.replace(/~~(\S(?:.|\n)*?\S)~~/g, '<del>$1</del>');

                return text;
            }
            
            // Function to type content with code blocks
            async function typeContent(element, parts) {
                for (const part of parts) {
                    if (part.type === 'text') {
                        await typeText(element, part.content);
                    } else if (part.type === 'code') {
                        await typeCodeBlock(element, part.content, part.language);
                    }
                }
            }
            
            // Function to type regular text
            async function typeText(element, text) {
                const speed = 10; // typing speed (lower is faster)
                const existingContent = element.innerHTML;
                
                for (let i = 0; i <= text.length; i++) {
                    element.innerHTML = existingContent + text.substring(0, i) + '<span class="typing-content"></span>';
                    await new Promise(resolve => setTimeout(resolve, speed));
                    
                    // Scroll to bottom as we type
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                
                element.innerHTML = existingContent + text;
            }
            
            // Function to type a code block
            async function typeCodeBlock(element, code, language) {
                const existingContent = element.innerHTML;
                const isHtml = language && language.toLowerCase() === 'html';
                
                // Create code block container
                const codeBlockId = 'code-' + Math.random().toString(36).substr(2, 9);
                element.innerHTML = existingContent + 
                    `<div class="code-block" id="${codeBlockId}">
                        <div class="code-header">
                            <span class="code-language">${language || 'code'}</span>
                            <div class="code-actions">
                                <button class="code-btn copy-btn" title="Copy code">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                                </button>
                                ${isHtml ? `
                                <button class="code-btn preview-btn" title="Toggle Preview">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="code-content">
                            <pre><code class="${language ? `language-${language}` : ''}"></code></pre>
                        </div>
                        ${isHtml ? `
                        <div class="code-preview-wrapper" style="display:none;">
                            <div class="code-preview-header">
                                <span>HTML Preview</span>
                            </div>
                            <iframe class="code-preview-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
                        </div>
                        ` : ''}
                    </div>`;
                
                const codeElement = document.querySelector(`#${codeBlockId} code`);
                const speed = 5; // typing speed for code (lower is faster)
                
                for (let i = 0; i <= code.length; i++) {
                    codeElement.textContent = code.substring(0, i);
                    await new Promise(resolve => setTimeout(resolve, speed));
                    
                    // Scroll to bottom as we type
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }

                // After typing is complete, highlight the block
                if (window.hljs) {
                    hljs.highlightElement(codeElement);
                }
            }
            
            // Function to add copy functionality to code blocks
            function addCopyFunctionality(messageDiv) {
                messageDiv.querySelectorAll('.copy-btn').forEach(btn => {
                    const originalIcon = btn.innerHTML;
                    const successIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>`;

                    btn.addEventListener('click', function() {
                        const codeBlock = this.closest('.code-block');
                        const codeContent = codeBlock.querySelector('code').textContent;
                        
                        navigator.clipboard.writeText(codeContent).then(() => {
                            this.innerHTML = successIcon;
                            
                            setTimeout(() => {
                                this.innerHTML = originalIcon;
                            }, 2000);
                        });
                    });
                });
            }
            
            // Function to add preview functionality to code blocks
            function addPreviewFunctionality(messageDiv) {
                messageDiv.querySelectorAll('.preview-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const codeBlock = this.closest('.code-block');
                        const previewWrapper = codeBlock.querySelector('.code-preview-wrapper');
                        if (!previewWrapper) return; // Should not happen if button exists

                        const iframe = previewWrapper.querySelector('.code-preview-iframe');
                        const codeContent = codeBlock.querySelector('code').textContent;
                        
                        if (previewWrapper.style.display === 'none') {
                            iframe.srcdoc = codeContent;
                            previewWrapper.style.display = 'block';
                            this.classList.add('active');
                        } else {
                            previewWrapper.style.display = 'none';
                            iframe.srcdoc = ''; // Clear content to save memory
                            this.classList.remove('active');
                        }
                        // Scroll to keep the view consistent
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    });
                });
            }
            
            // Function to add message immediately (without typing effect)
            function addMessage(sender, content, fileInfo = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message message-${sender}`;
                
                let contentHTML = '';

                // Xử lý hiển thị file cho tin nhắn của người dùng
                if (sender === 'user' && fileInfo) {
                    const fileData = fileInfo.data;
                    if (fileData.type === 'image') {
                        // Đối với hình ảnh, hiển thị ảnh
                        contentHTML += `<img src="${fileData.url}" class="file-preview" style="display: block; margin-bottom: 8px; border-radius: 8px; max-width: 300px; max-height: 300px;">`;
                    } else {
                        // Đối với các tệp khác, hiển thị nhãn văn bản
                        contentHTML += `<p style="font-style: italic; color: var(--text-secondary); margin-bottom: 8px; padding: 8px 12px; background-color: var(--bg-hover); border-radius: 6px; border: 1px solid var(--border-light);">📎 File đính kèm: <strong>${fileInfo.file.name}</strong></p>`;
                    }
                }

                // Xử lý nội dung văn bản nếu có
                if (content && content.trim() !== '') {
                    const processedContent = processContentWithCodeBlocks(content);
                    for (const part of processedContent) {
                        if (part.type === 'text') {
                            contentHTML += part.content; // Đã xử lý markdown
                        } else if (part.type === 'code') {
                            const codeBlockId = 'code-' + Math.random().toString(36).substr(2, 9);
                            const isHtml = part.language && part.language.toLowerCase() === 'html';
                            contentHTML += `
                                <div class="code-block" id="${codeBlockId}">
                                    <div class="code-header">
                                        <span class="code-language">${part.language || 'code'}</span>
                                        <div class="code-actions">
                                            <button class="code-btn copy-btn" title="Copy code">
                                                <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                                            </button>
                                            ${isHtml ? `
                                            <button class="code-btn preview-btn" title="Toggle Preview">
                                                <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                                            </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="code-content">
                                        <pre><code class="${part.language ? `language-${part.language}` : ''}">${escapeHtml(part.content)}</code></pre>
                                    </div>
                                    ${isHtml ? `
                                    <div class="code-preview-wrapper" style="display:none;">
                                        <div class="code-preview-header">
                                            <span>HTML Preview</span>
                                        </div>
                                        <iframe class="code-preview-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        }
                    }
                }

                messageDiv.innerHTML = `
                    <div class="message-user">
                        <div class="message-avatar ${sender === 'user' ? 'user-avatar-bg' : 'message-ai'}">
                            ${sender === 'user' ? 
                                '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>' :
                                '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" /></svg>'}
                        </div>
                        <div class="message-content">${contentHTML}</div>
                    </div>
                `;

                chatContainer.insertBefore(messageDiv, typingIndicator);
                
                // Highlight all new code blocks
                messageDiv.querySelectorAll('pre code').forEach((block) => {
                    if (window.hljs) {
                        hljs.highlightElement(block);
                    }
                });

                // Add copy functionality to code blocks
                addCopyFunctionality(messageDiv);
                // Add preview functionality to code blocks
                addPreviewFunctionality(messageDiv);
            }
            
            function createDeepThinkPanel() {
                const panelDiv = document.createElement('div');
                panelDiv.className = 'message message-ai deep-think-panel';
                panelDiv.innerHTML = `
                    <div class="message-user">
                        <div class="message-avatar message-ai">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" /></svg>
                        </div>
                        <div class="message-content ai-panel-content">
                            <div class="deep-think-header">
                                <div class="deep-think-header-main">
                                    <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"></path></svg> Deep Thinking...</h3>
                                    <div class="deep-think-timer">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        <span class="deep-think-timer-value">0s</span>
                                    </div>
                                </div>
                                <button class="panel-toggle-btn" title="Ẩn/Hiện chi tiết"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg></button>
                            </div>
                            <div class="panel-body">
                                <div class="deep-think-section">
                                    <h4>Quá trình suy nghĩ</h4>
                                    <div class="thought-process-content"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return panelDiv;
            }

            function createResearchPanel() {
                const panelDiv = document.createElement('div');
                panelDiv.className = 'message message-ai research-panel';
                panelDiv.innerHTML = `
                    <div class="message-user">
                        <div class="message-avatar message-ai">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                        </div>
                        <div class="message-content ai-panel-content">
                            <div class="deep-think-header">
                                <div class="deep-think-header-main">
                                    <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg> Đang nghiên cứu...</h3>
                                    <div class="deep-think-timer">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        <span class="deep-think-timer-value">0s</span>
                                    </div>
                                </div>
                                <button class="panel-toggle-btn" title="Ẩn/Hiện chi tiết"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg></button>
                            </div>
                            <div class="panel-body">
                                <div class="deep-think-section"><h4>Bước 1: Tìm kiếm trên Web</h4><div class="step-1-content thought-step">Đang khởi tạo...</div></div>
                                <div class="deep-think-section"><h4>Bước 2: Tổng hợp thông tin</h4><div class="step-2-content thought-step">Đang chờ...</div></div>
                                <div class="deep-think-section"><h4>Bước 3: Tìm kiếm hình ảnh</h4><div class="step-3-content thought-step">Đang chờ...</div></div>
                                <div class="deep-think-section"><h4>Bước 4: Soạn thảo báo cáo</h4><div class="step-4-content thought-step">Đang chờ...</div></div>
                            </div>
                        </div>
                    </div>
                `;
                return panelDiv;
            }

            function createSearchPanel() {
                const panelDiv = document.createElement('div');
                panelDiv.className = 'message message-ai search-panel';
                panelDiv.innerHTML = `
                    <div class="message-user">
                        <div class="message-avatar message-ai">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                        </div>
                        <div class="message-content ai-panel-content">
                            <div class="search-panel-header deep-think-header">
                                <div class="deep-think-header-main">
                                    <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg> Đang tìm kiếm...</h3>
                                    <div class="deep-think-timer">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        <span class="deep-think-timer-value">0s</span>
                                    </div>
                                </div>
                                <button class="panel-toggle-btn" title="Ẩn/Hiện chi tiết"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg></button>
                            </div>
                            <div class="panel-body">
                                <div class="deep-think-section"><h4 class="step-1-header">Bước 1: Các kết quả tìm kiếm</h4><div class="search-results-content"></div></div>
                                <div class="deep-think-section"><h4>Bước 2 & 3: Phân tích và lựa chọn</h4><div class="simulated-steps-content"></div></div>
                            </div>
                        </div>
                    </div>
                `;
                return panelDiv;
            }

            function startTimer(timerElement) {
                let seconds = 0;
                timerElement.textContent = '0s';
                deepThinkTimerInterval = setInterval(() => {
                    seconds++;
                    const min = Math.floor(seconds / 60);
                    const sec = seconds % 60;
                    timerElement.textContent = (min > 0 ? `${min}m ` : '') + `${sec}s`;
                }, 1000);
            }

            async function simulateThinkingProcess(container) {
                const steps = [
                    "Phân tích yêu cầu của người dùng...",
                    "Xác định các khái niệm và từ khóa chính...",
                    "Tra cứu và tổng hợp thông tin từ cơ sở dữ liệu...",
                    "Lập dàn ý cho câu trả lời...",
                    "Soạn thảo câu trả lời chi tiết...",
                    "Kiểm tra lại tính chính xác và logic..."
                ];
                for (const step of steps) {
                    await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 500));
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'thought-step';
                    stepDiv.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> <span>${step}</span>`;
                    container.appendChild(stepDiv);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }

            async function simulateDeeperThinkingProcess(container) {
                const steps = [
                    "Phân tích cấu trúc câu hỏi...",
                    "Xác định các giả định ngầm...",
                    "Lên ý tưởng về các hướng tiếp cận tiềm năng...",
                    "Truy vấn các cơ sở kiến thức chuyên ngành...",
                    "Đối chiếu các nguồn thông tin chính để tìm mâu thuẫn...",
                    "Tổng hợp các phát hiện thành một cấu trúc mạch lạc...",
                    "Soạn thảo bản nháp phản hồi ban đầu...",
                    "Tinh chỉnh các lập luận và thêm sắc thái...",
                    "Thực hiện đánh giá cuối cùng về sự rõ ràng và chính xác...",
                    "Tối ưu hóa câu trả lời để dễ hiểu hơn..."
                ];
                
                const minDuration = 30000; // At least 30 seconds
                const startTime = Date.now();

                for (const step of steps) {
                    await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 1500));
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'thought-step';
                    stepDiv.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> <span>${step}</span>`;
                    container.appendChild(stepDiv);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }

                const elapsedTime = Date.now() - startTime;
                if (elapsedTime < minDuration) {
                    await new Promise(resolve => setTimeout(resolve, minDuration - elapsedTime));
                }
            }

            async function simulateDeepestThinkingProcess(container) {
                const steps = [
                    "Khởi tạo quá trình phân tích đa chiều...",
                    "Phân rã câu hỏi thành các thành phần cốt lõi...",
                    "Xác định các mô hình khái niệm và mối quan hệ ẩn...",
                    "Thực hiện truy vấn song song trên nhiều cơ sở kiến thức...",
                    "Mô phỏng các kịch bản và giả thuyết phản biện...",
                    "Phân tích cảm tính và sắc thái trong ngữ cảnh...",
                    "Đối chiếu chéo thông tin để đảm bảo tính nhất quán tuyệt đối...",
                    "Xây dựng một cây lập luận logic phức tạp...",
                    "Soạn thảo phản hồi nháp với nhiều góc nhìn...",
                    "Tự phê bình và tinh chỉnh câu trả lời để đạt độ chính xác cao nhất...",
                    "Kiểm tra lại các ràng buộc về đạo đức và an toàn...",
                    "Định dạng đầu ra để tối ưu hóa sự rõ ràng và tác động...",
                    "Hoàn tất quá trình tổng hợp thông tin..."
                ];
                
                const minDuration = 80000; // At least 80 seconds
                const startTime = Date.now();

                for (const step of steps) {
                    await new Promise(resolve => setTimeout(resolve, 4000 + Math.random() * 2000));
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'thought-step';
                    stepDiv.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> <span>${step}</span>`;
                    container.appendChild(stepDiv);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }

                const elapsedTime = Date.now() - startTime;
                if (elapsedTime < minDuration) {
                    await new Promise(resolve => setTimeout(resolve, minDuration - elapsedTime));
                }
            }

            // Hàm thực hiện tìm kiếm bằng Google Custom Search API
            async function performInternetSearch(query, showUIMessage) {
                if (!CUSTOM_SEARCH_API_KEY || !CUSTOM_SEARCH_ENGINE_ID) {
                    console.warn("Chức năng tìm kiếm chưa được cấu hình.");
                    return { error: "[Ghi chú cho AI: Hãy thông báo cho người dùng rằng chức năng tìm kiếm trên Internet chưa được cấu hình, vì vậy bạn không thể trả lời các câu hỏi cần thông tin thời gian thực.]" };
                }

                if (showUIMessage) {
                    // This message is now part of the panel, so we don't need a separate chat bubble.
                    // addMessage('ai', `Đang tìm kiếm trên Internet cho: "${query}"...`);
                }
                const searchUrl = `https://www.googleapis.com/customsearch/v1?key=${CUSTOM_SEARCH_API_KEY}&cx=${CUSTOM_SEARCH_ENGINE_ID}&q=${encodeURIComponent(query)}`;

                try {
                    // Sử dụng fetchWithRetry cho Custom Search API
                    const response = await fetchWithRetry(searchUrl, {}, 2, 500); // Thử lại 2 lần, bắt đầu từ 0.5s
                    const data = await response.json();
                    return { items: data.items || [] };
                } catch (error) {
                    console.error("Failed to fetch from Custom Search API:", error);
                    // Lỗi đã được định dạng bởi fetchWithRetry, chỉ cần trích xuất thông báo
                    return { error: `[Gặp lỗi khi kết nối tới dịch vụ tìm kiếm: ${error.message}]` };
                }
            }

            // Hàm thực hiện tìm kiếm hình ảnh
            async function performImageSearch(query) {
                if (!CUSTOM_SEARCH_API_KEY || !CUSTOM_SEARCH_ENGINE_ID) {
                    console.warn("Chức năng tìm kiếm chưa được cấu hình.");
                    return { error: "Chức năng tìm kiếm chưa được cấu hình." };
                }
                const searchUrl = `https://www.googleapis.com/customsearch/v1?key=${CUSTOM_SEARCH_API_KEY}&cx=${CUSTOM_SEARCH_ENGINE_ID}&q=${encodeURIComponent(query)}&searchType=image`;

                try {
                    const response = await fetchWithRetry(searchUrl, {}, 2, 500);
                    const data = await response.json();
                    return { items: data.items || [] };
                } catch (error) {
                    console.error("Failed to fetch from Custom Image Search API:", error);
                    return { error: `[Gặp lỗi khi kết nối tới dịch vụ tìm kiếm hình ảnh: ${error.message}]` };
                }
            }

            // Lấy URL của favicon từ một URL trang web
            function getFaviconUrl(url) {
                try {
                    const domain = new URL(url).hostname;
                    // Sử dụng dịch vụ của Google để lấy favicon, kích thước 32x32
                    return `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
                } catch (e) {
                    // Trả về một pixel trong suốt nếu URL không hợp lệ
                    return 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                }
            }
            
            // Helper function to escape HTML
            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
            
            // Function to read and process uploaded files
            async function readFile(file) {
                return new Promise((resolve, reject) => {
                    if (file.type.startsWith('image/')) {
                        if (file.size > 20 * 1024 * 1024) {
                            reject('Hình ảnh quá lớn (tối đa 20MB).');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = () => {
                            const base64 = reader.result.split(',')[1];
                            resolve({ type: 'image', base64, mimeType: file.type, url: URL.createObjectURL(file) });
                        };
                        reader.onerror = () => reject('Lỗi đọc hình ảnh');
                        reader.readAsDataURL(file);
                    } else if (file.type === 'text/plain') {
                        const reader = new FileReader();
                        reader.onload = () => resolve({ type: 'text', content: reader.result });
                        reader.onerror = () => reject('Lỗi đọc file TXT');
                        reader.readAsText(file);
                    } else if (file.type === 'application/pdf') {
                        const reader = new FileReader();
                        reader.onload = async () => {
                            try {
                                const pdf = await pdfjsLib.getDocument(reader.result).promise;
                                let text = '';
                                for (let i = 1; i <= pdf.numPages; i++) {
                                    const page = await pdf.getPage(i);
                                    const content = await page.getTextContent();
                                    text += content.items.map(item => item.str).join(' ') + '\n';
                                }
                                resolve({ type: 'text', content: text });
                            } catch (error) {
                                reject('Lỗi đọc file PDF');
                            }
                        };
                        reader.onerror = () => reject('Lỗi đọc file PDF');
                        reader.readAsArrayBuffer(file);
                    } else if (file.type === 'application/vnd.ms-powerpoint' || 
                              file.type === 'application/vnd.openxmlformats-officedocument.presentationml.presentation') {
                        const reader = new FileReader();
                        reader.onload = async () => {
                            try {
                                const zip = await JSZip.loadAsync(reader.result);
                                let text = '';
                                const slides = [];
                                const slideFiles = Object.keys(zip.files).filter(f => f.startsWith('ppt/slides/slide')).sort();
                                for (const slideFile of slideFiles) {
                                    const xml = await zip.file(slideFile).async('string');
                                    const parser = new DOMParser();
                                    const doc = parser.parseFromString(xml, 'application/xml');
                                    const textNodes = doc.getElementsByTagName('a:t');
                                    let slideText = [];
                                    for (let i = 0; i < textNodes.length; i++) {
                                        const text = textNodes[i].textContent.trim();
                                        if (text) slideText.push(text);
                                    }
                                    text += slideText.join(' ') + '\n';
                                    const title = slideText[0] || `Slide ${slides.length + 1}`;
                                    const content = slideText.slice(1).join('\n') || 'Không có nội dung.';
                                    slides.push({ title, content });
                                }
                                resolve({ type: 'powerpoint', content: text.trim(), slides: slides.slice(0, 10) });
                            } catch (error) {
                                reject('Lỗi đọc file PowerPoint');
                            }
                        };
                        reader.onerror = () => reject('Lỗi đọc file PowerPoint');
                        reader.readAsArrayBuffer(file);
                    } else {
                        reject('Định dạng file không hỗ trợ');
                    }
                });
            }
            
            // Function to format file size
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Handle new chat button
            newChatBtn.addEventListener('click', function() {
                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                }
                
                // Clear chat messages
                const messages = document.querySelectorAll('.message');
                messages.forEach(msg => msg.remove());
                const panels = document.querySelectorAll('.ai-panel-content');

                // Clear chat history and reset UI
                chatHistory = [];
                uploadedFile = null;
                
                // Show empty state
                if (emptyState) {
                    emptyState.style.display = 'flex';
                }
                
                // Hide typing indicator if visible
                typingIndicator.style.display = 'none';
                
                currentConversationId = null;
                renderChatHistorySidebar();

                // Reset input
                messageInput.value = '';
                sendBtn.disabled = true;
            });
            
            // --- Conversation Management ---
            function saveConversations() {
                localStorage.setItem('starx_chat_conversations', JSON.stringify(conversations));
            }

            function loadConversations() {
                const savedConversations = localStorage.getItem('starx_chat_conversations');
                if (savedConversations) {
                    conversations = JSON.parse(savedConversations);
                }
                renderChatHistorySidebar();
                
                // Load the most recent conversation on startup
                if (conversations.length > 0) {
                    loadConversation(conversations[0].id);
                }
            }

            function getRelativeDateGroup(timestamp) {
                const now = new Date();
                const date = new Date(timestamp);
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                if (date >= today) {
                    return "Hôm nay";
                } else if (date >= yesterday) {
                    return "Hôm qua";
                } else {
                    // Format as DD / MM / YYYY
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day} / ${month} / ${year}`;
                }
            }

            function renderChatHistorySidebar() {
                chatHistoryContainer.innerHTML = '';
                conversations.sort((a, b) => b.timestamp - a.timestamp); // Sort by most recent

                if (conversations.length === 0) {
                    chatHistoryContainer.innerHTML = '<p style="padding: 16px; color: var(--text-secondary); font-size: 14px; text-align: center;">Chưa có cuộc trò chuyện nào.</p>';
                    return;
                }

                const groupedConversations = conversations.reduce((groups, convo) => {
                    const groupName = getRelativeDateGroup(convo.timestamp);
                    if (!groups[groupName]) {
                        groups[groupName] = [];
                    }
                    groups[groupName].push(convo);
                    return groups;
                }, {});

                for (const groupName in groupedConversations) {
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'history-group-header';
                    groupHeader.textContent = groupName;
                    chatHistoryContainer.appendChild(groupHeader);

                    groupedConversations[groupName].forEach(convo => {
                        const item = document.createElement('div');
                        item.className = 'chat-item';
                        item.dataset.id = convo.id;
                        if (convo.id === currentConversationId) {
                            item.classList.add('active');
                        }

                        item.innerHTML = `
                            <span class="chat-item-title">${escapeHtml(convo.title)}</span>
                            <div class="chat-item-actions">
                                <button class="chat-item-btn rename-btn" title="Đổi tên">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg>
                                </button>
                                <button class="chat-item-btn delete-btn" title="Xóa">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                                </button>
                            </div>
                        `;

                        item.addEventListener('click', (e) => {
                            // Prevent loading conversation if a button was clicked
                            if (!e.target.closest('.chat-item-btn')) {
                                loadConversation(convo.id);
                            }
                        });
                        chatHistoryContainer.appendChild(item);
                    });
                }
            }

            function loadConversation(id) {
                const convoToLoad = conversations.find(c => c.id === id);
                if (!convoToLoad) return;

                currentConversationId = id;
                chatHistory = convoToLoad.messages;

                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                }

                // Clear UI
                chatContainer.innerHTML = ''; // Clear all messages and panels
                chatContainer.appendChild(typingIndicator); // Re-add typing indicator
                chatContainer.appendChild(fileStatusIndicator); // Re-add file status indicator
                
                if (emptyState) {
                    emptyState.style.display = 'none';
                }

                // Render messages from the loaded conversation
                chatHistory.forEach(msg => {
                    // Simplified rendering for history, assuming text only for now
                    // The `addMessage` function can be adapted if file previews are needed in history
                    const content = msg.parts.map(p => p.text || '').join(' ');
                    addMessage(msg.role === 'model' ? 'ai' : 'user', content);
                });

                renderChatHistorySidebar();
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function handleDeleteConversation(convoId) {
                showConfirmationModal(
                    'Xóa cuộc trò chuyện',
                    'Bạn có chắc chắn muốn xóa cuộc trò chuyện này không? Hành động này không thể hoàn tác.',
                    'Xóa',
                    () => {
                        conversations = conversations.filter(c => c.id !== convoId);
                        saveConversations();

                        if (currentConversationId === convoId) {
                            newChatBtn.click();
                        } else {
                            renderChatHistorySidebar();
                        }
                    }
                );
            }

            function handleRenameConversation(convoId, chatItem) {
                const titleSpan = chatItem.querySelector('.chat-item-title');
                const currentTitle = titleSpan.textContent;
                chatItem.classList.add('editing');

                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'chat-item-input';
                input.value = currentTitle;

                titleSpan.replaceWith(input);
                input.focus();
                input.select();

                const saveRename = () => {
                    const newTitle = input.value.trim();
                    if (newTitle && newTitle !== currentTitle) {
                        const convo = conversations.find(c => c.id === convoId);
                        if (convo) {
                            convo.title = newTitle;
                            saveConversations();
                        }
                    }
                    renderChatHistorySidebar();
                };

                input.addEventListener('blur', saveRename);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        saveRename();
                    } else if (e.key === 'Escape') {
                        renderChatHistorySidebar();
                    }
                });
            }
            
            // Focus input when clicking on empty state (mobile)
            if (emptyState) {
                emptyState.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        messageInput.focus();
                    }
                });
            }

            // Theme switcher
            function setTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    hljsLightTheme.disabled = true;
                    hljsDarkTheme.disabled = false;
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    hljsLightTheme.disabled = false;
                    hljsDarkTheme.disabled = true;
                    localStorage.setItem('theme', 'light');
                }
            }

            themeToggleBtn.addEventListener('click', () => {
                const currentTheme = localStorage.getItem('theme') || 'light';
                if (currentTheme === 'light') {
                    setTheme('dark');
                } else {
                    setTheme('light');
                }
            });

            // Apply saved theme on load
            const savedTheme = localStorage.getItem('theme') || 'light'; // Default to light
            setTheme(savedTheme);

            // Load user profile and chat history from localStorage on startup
            loadUserProfile();
            loadConversations();
        });
    </script>
</body>
</html>
